<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è‡ªå‹•è²©å£²æ©Ÿã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap');

      :root {
        --accent: #ff7eb6;
        --accent-2: #6c8cff;
        --border: #e5e7f0;
        --muted: #f7f8ff;
        --text: #1f2430;
        --shadow: 0 12px 28px rgba(61, 78, 255, 0.08);
      }

      body {
        margin: 0;
        font-family: 'Noto Sans JP', 'Baloo 2', system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 10% 20%, #fff3fb 0, #f1f6ff 45%, #ffffff 90%);
        color: var(--text);
      }

      .page {
        max-width: 1040px;
        margin: 0 auto;
        padding: 28px 16px 60px;
      }

      h1 {
        font-size: 30px;
        margin: 0 0 12px;
        letter-spacing: 0.02em;
      }

      h2 {
        margin: 4px 0 6px;
      }

      p.lead {
        margin: 0 0 18px;
        color: #3a3f52;
        line-height: 1.7;
      }

      header.hero {
        background: linear-gradient(120deg, rgba(255, 126, 182, 0.12), rgba(108, 140, 255, 0.12));
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 22px 20px 20px;
        box-shadow: var(--shadow);
      }

      .hero-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #fff;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 600;
      }

      .pill.accent {
        background: #1f1f1f;
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      }

      .pill.alt {
        background: #fff1f8;
        color: #ff4f9d;
        border-color: #ffd7eb;
      }

      section {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px 16px 20px;
        margin-top: 16px;
        box-shadow: var(--shadow);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
      }

      .section-lead {
        margin: 0;
        color: #4a5066;
        line-height: 1.6;
        font-size: 14px;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: 700;
        color: #8b92b2;
        font-size: 12px;
        margin: 0;
      }

      .counter {
        background: linear-gradient(120deg, #ffd7eb, #dfe3ff);
        color: #2c2c54;
        padding: 10px 14px;
        border-radius: 14px;
        font-weight: 700;
        min-width: 86px;
        text-align: center;
        box-shadow: var(--shadow);
      }

      .category-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 12px 0 8px;
      }

      .tab {
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 12px;
        padding: 8px 14px;
        cursor: pointer;
        transition: 0.15s;
        font-weight: 700;
        color: #2e2f44;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.03);
      }

      .tab.active {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        border-color: transparent;
        box-shadow: 0 8px 20px rgba(255, 126, 182, 0.35);
      }

      .vending-window {
        position: relative;
        padding: 14px;
        background: linear-gradient(180deg, #ecf0ff 0%, #ffffff 50%, #f5f7ff 100%);
        border: 2px solid #d7def8;
        border-radius: 18px;
        box-shadow:
          inset 0 2px 8px rgba(255, 255, 255, 0.6),
          0 18px 36px rgba(26, 47, 120, 0.12);
      }

      .vending-window::before {
        content: '';
        position: absolute;
        inset: 10px 18px auto 18px;
        height: 12px;
        border-radius: 8px;
        background: linear-gradient(90deg, rgba(255, 255, 255, 0.8), rgba(255, 255, 255, 0));
        opacity: 0.7;
        pointer-events: none;
      }

      .card-grid {
        position: relative;
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        align-items: stretch;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: linear-gradient(180deg, #ffffff 0%, #f7f8ff 60%, #eef1ff 100%);
        transition: 0.18s;
        cursor: grab;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
        box-shadow: 0 6px 18px rgba(22, 42, 97, 0.08);
        align-items: center;
        text-align: center;
      }

      .card:hover {
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
      }

      .card.disabled {
        filter: grayscale(0.6);
        opacity: 0.5;
        pointer-events: none;
      }

      .card.selected {
        border: 2px solid var(--accent);
        box-shadow: 0 16px 28px rgba(255, 126, 182, 0.26);
      }

      .selection-layout {
        display: grid;
        grid-template-columns: 2.2fr 1fr;
        gap: 16px;
        align-items: start;
      }

      .vending-area {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .selection-panel {
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        background: #fff;
        box-shadow: var(--shadow);
      }

      .selection-panel h3 {
        margin: 0 0 10px;
        font-size: 16px;
      }

      .rank-list {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .rank-item {
        border: 1px dashed var(--border);
        border-radius: 10px;
        padding: 10px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      }

      .rank-item.active {
        border-color: var(--accent);
        box-shadow: 0 10px 20px rgba(255, 126, 182, 0.15);
      }

      .rank-item.drag-over {
        border-color: var(--accent);
        background: #fff7fd;
        box-shadow: 0 12px 26px rgba(255, 126, 182, 0.2);
      }

      .rank-label {
        font-weight: 800;
        color: #2e2f44;
        min-width: 70px;
      }

      .rank-content {
        display: flex;
        flex-direction: column;
        gap: 4px;
        font-size: 14px;
      }

      .rank-empty {
        color: #7b819a;
      }

      .media-frame {
        width: 100%;
        aspect-ratio: 2 / 3;
        min-height: 220px;
        border-radius: 12px;
        background: linear-gradient(145deg, #fdf3ff, #f0f5ff);
        border: 1px solid var(--border);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 4px 10px rgba(255, 255, 255, 0.8);
      }

      .media-frame iframe {
        width: 100%;
        height: 100%;
        border: 0;
        background: transparent;
        pointer-events: none;
      }

      .media-frame img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        background: transparent;
      }

      .card h4 {
        margin: 0;
        font-size: 15px;
      }

      .card .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #555;
        gap: 8px;
        width: 100%;
      }

      .card .price {
        font-size: 16px;
        font-weight: 800;
        color: var(--accent);
      }

      .card .meta,
      .card h4 {
        width: 100%;
      }

      .card .maker {
        font-weight: 700;
        color: #34354a;
      }

      textarea {
        width: 100%;
        min-height: 140px;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 15px;
        resize: vertical;
        box-sizing: border-box;
        background: #fff;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 18px;
        flex-wrap: wrap;
      }

      button.primary {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        border: none;
        border-radius: 14px;
        padding: 12px 22px;
        font-size: 15px;
        cursor: pointer;
        box-shadow: 0 14px 26px rgba(255, 126, 182, 0.35);
        transition: 0.18s;
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      button.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .status {
        font-size: 14px;
        color: #3c3d52;
        padding: 10px 12px;
        background: #f8f9ff;
        border: 1px solid var(--border);
        border-radius: 12px;
        min-height: 20px;
      }

      .status.error {
        background: #fff5f8;
        color: #d6266f;
        border-color: #ffc0d7;
      }

      .badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #fff;
        color: var(--accent);
        padding: 4px 8px;
        border-radius: 10px;
        border: 1px solid var(--accent);
        font-weight: 700;
        font-size: 12px;
      }

      .rank-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        padding: 4px 10px;
        border-radius: 10px;
        font-weight: 800;
        font-size: 12px;
        box-shadow: 0 10px 20px rgba(255, 126, 182, 0.35);
      }

      .muted {
        color: #666;
      }

      .empty {
        padding: 14px;
        background: var(--muted);
        border-radius: 10px;
        text-align: center;
      }

      .note {
        color: #4b4f65;
        background: #fdf3ff;
        border: 1px dashed #ffc0df;
        padding: 10px 12px;
        border-radius: 12px;
        margin: 6px 0 10px;
      }

      .alert {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #ffc0d7;
        background: #fff5f8;
        color: #c22463;
        display: none;
      }

      .alert.visible {
        display: block;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      .question-tabs {
        display: inline-flex;
        gap: 10px;
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 4px;
        background: #f8f9ff;
        box-shadow: var(--shadow);
        flex-wrap: wrap;
      }

      .question-tab {
        border: none;
        background: transparent;
        padding: 10px 14px;
        border-radius: 10px;
        cursor: pointer;
        font-weight: 700;
        color: #3a3f52;
        transition: 0.15s;
      }

      .question-tab.active {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        box-shadow: 0 10px 20px rgba(255, 126, 182, 0.35);
      }

      .question-panels {
        margin-top: 12px;
      }

      .question-panel {
        display: none;
        margin-top: 10px;
      }

      .question-panel.active {
        display: block;
      }

      .required-hint {
        margin: 0 0 6px;
        color: #c22463;
        font-weight: 700;
        font-size: 13px;
      }

      .ranking-view {
        margin-top: 16px;
      }

      .ranking-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .ranking-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 14px;
        margin-top: 14px;
      }

      .ranking-card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        background: linear-gradient(180deg, #ffffff 0%, #f8f9ff 50%, #eef1ff 100%);
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
      }

      .ranking-card .media-frame {
        aspect-ratio: 3 / 4;
        min-height: 200px;
      }

      .ranking-rank {
        font-weight: 800;
        color: #fff;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        padding: 6px 12px;
        border-radius: 12px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        box-shadow: 0 12px 24px rgba(255, 126, 182, 0.35);
        width: fit-content;
      }

      .ranking-rank .pts {
        background: rgba(255, 255, 255, 0.18);
        padding: 4px 10px;
        border-radius: 10px;
      }

      .ranking-meta {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 8px;
        flex-wrap: wrap;
        color: #4a5066;
        font-size: 14px;
      }

      .close-tab-btn {
        background: #1f1f1f;
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 10px 16px;
        font-size: 14px;
        cursor: pointer;
        box-shadow: 0 12px 22px rgba(0, 0, 0, 0.18);
      }

      .maker-highlight {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 14px;
        background: linear-gradient(120deg, rgba(255, 126, 182, 0.06), rgba(108, 140, 255, 0.08));
        box-shadow: var(--shadow);
        margin-top: 12px;
        display: none;
      }

      .maker-highlight.visible {
        display: block;
      }

      .maker-highlight-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 10px;
        flex-wrap: wrap;
      }

      .maker-highlight-body {
        display: grid;
        grid-template-columns: 1.2fr 1fr;
        gap: 12px;
        align-items: center;
        margin-top: 10px;
      }

      .maker-highlight .media-frame {
        aspect-ratio: 4 / 3;
        min-height: 160px;
      }

      .maker-highlight-title {
        margin: 2px 0 4px;
        font-size: 18px;
        letter-spacing: 0.02em;
      }

      .maker-highlight-meta {
        margin: 0;
        color: #4a5066;
        font-weight: 600;
      }

      @media (max-width: 600px) {
        .selection-layout {
          grid-template-columns: 1fr;
        }
        h1 {
          font-size: 24px;
        }
        .media-frame {
          min-height: 180px;
        }
        .maker-highlight-body {
          grid-template-columns: 1fr;
        }
      }
    </style>
  </head>
  <body style="margin:auto 0;padding:auto 0;">
    <div class="page">
      <div id="form-view" class="view active">
        <header class="hero">
          <div class="hero-badges">
            <span class="pill accent">New Office Break Time</span>
            <span class="pill alt">ã¿ã‚“ãªã§æŠ•ç¥¨</span>
          </div>
          <h1>ğŸ‰ æ–°ã‚ªãƒ•ã‚£ã‚¹ã®è‡ªè²©æ©Ÿã€ã¿ã‚“ãªã§æ±ºã‚ã¡ã‚ƒãŠã†!</h1>
          <p class="lead">
            æ–°ã—ã„ã‚ªãƒ•ã‚£ã‚¹ã«è¨­ç½®ã™ã‚‹è‡ªè²©æ©Ÿã‚’ã€ã‚ãªãŸã®ä¸€ç¥¨ã§æ±ºå®šã—ã¾ã™! æ¯æ—¥ã®ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ã‚’æœ€é«˜ã«ã™ã‚‹ãŸã‚ã€ã¿ã‚“ãªã®ã€Œé£²ã¿ãŸã„!ã€ã‚’æ•™ãˆã¦ãã ã•ã„âœ¨
          </p>
          <div class="hero-badges">
            <span class="pill">ç”»åƒã‚’ãƒãƒãƒƒã¨æŠ¼ã™ã ã‘</span>
            <span class="pill">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ã‚«ã‚¦ãƒ³ãƒˆ</span>
            <span class="pill">è‡ªç”±è¨˜å…¥ã‚‚å¤§æ­“è¿</span>
          </div>
        </header>

        <section id="q1">
          <div class="section-header">
            <div>
              <p class="eyebrow">STEP 1</p>
              <h2>â˜• ã‚ãªãŸã®æ¨ã—ãƒ‰ãƒªãƒ³ã‚¯TOP3ã‚’æ•™ãˆã¦!</h2>
              <p class="section-lead">
                ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸ã¶ã¨ã€ã‚ºãƒ©ãƒªã¨å•†å“ãŒç™»å ´! å¥½ããªãƒ‰ãƒªãƒ³ã‚¯ç”»åƒã‚’å³ã®ã€Œ1ä½ã€œ3ä½ã€æ ã¸ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„ã€‚
                <br />æ ã®ä¸­ã§ã‚‚ãƒ‰ãƒ©ãƒƒã‚°ã§é †ç•ªã‚’å…¥ã‚Œæ›¿ãˆã‚‰ã‚Œã¾ã™ã€‚1ä½â†’3pt / 2ä½â†’2pt / 3ä½â†’1ptã§é›†è¨ˆã•ã‚Œã¾ã™ã€‚
              </p>
            </div>
            <div class="counter" id="product-count">0/3</div>
          </div>
          <div class="note">
            ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ãã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚å•†å“ç”»åƒã‚’é †ä½æ ã«ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦é¸ã³ã€æ å†…ã®ãƒ‰ãƒ©ãƒƒã‚°ã§ä¸¦ã³æ›¿ãˆã§ãã¾ã™ã€‚
            é‡è¤‡ã‚’é¸ã‚“ã å ´åˆã¯å¤ã„ã»ã†ã®é †ä½ãŒè§£é™¤ã•ã‚Œã¾ã™ã€‚
          </div>
          <div class="selection-layout">
            <div class="vending-area">
              <div class="category-tabs" id="category-tabs"></div>
              <div class="vending-window">
                <div id="product-grid" class="card-grid"></div>
              </div>
            </div>
            <aside class="selection-panel">
              <h3>ã‚ãªãŸã®TOP3</h3>
              <div class="rank-list" id="rank-list"></div>
            </aside>
          </div>
        </section>

        <section id="q2">
          <p class="eyebrow">STEP 2</p>
          <h2>ğŸ’¬ 2ã¤ã®è³ªå•ã«ç­”ãˆã¦ãã ã•ã„ï¼ˆå¿…é ˆï¼‰</h2>
          <p class="section-lead">ã‚¿ãƒ–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚·ãƒ¼ãƒ ãƒ¬ã‚¹ã«åˆ‡ã‚Šæ›¿ãˆãªãŒã‚‰ã€ã©ã¡ã‚‰ã®è³ªå•ã«ã‚‚å¿…ãšå›ç­”ã—ã¦ãã ã•ã„ã€‚</p>
          <div class="question-tabs" id="question-tabs">
            <button class="question-tab active" data-key="now">ä»Šé£²ã¿ãŸã„ã‚‚ã®ã¯ï¼Ÿ</button>
            <button class="question-tab" data-key="hot">ä»Šæ—¥ãŒ40åº¦ã®æš‘ã„æ—¥ã ã¨ã—ã¦ã€é£²ã¿ãŸã„ã‚‚ã®ã¯ï¼Ÿ</button>
          </div>
          <div class="question-panels" id="question-panels">
            <div class="question-panel active" data-key="now">
              <p class="required-hint">*å¿…é ˆ</p>
              <textarea id="answer-now" placeholder="ä¾‹ï¼šå†·ãŸã„ã‚¢ã‚¤ã‚¹ã‚³ãƒ¼ãƒ’ãƒ¼ã€ã‚·ãƒ¥ãƒ¯ã£ã¨ã—ãŸç‚­é…¸ãªã©"></textarea>
            </div>
            <div class="question-panel" data-key="hot">
              <p class="required-hint">*å¿…é ˆ</p>
              <textarea id="answer-hot" placeholder="ä¾‹ï¼šã‚¹ãƒãƒ¼ãƒ„ãƒ‰ãƒªãƒ³ã‚¯ã€ã‚­ãƒ³ã‚­ãƒ³ã«å†·ãˆãŸãŠèŒ¶ ãªã©"></textarea>
            </div>
          </div>
        </section>

        <div class="actions">
          <button class="primary" id="submit-btn">ã“ã®å†…å®¹ã§é€ä¿¡ã™ã‚‹ ğŸš€</button>
          <div class="status" id="status"></div>
        </div>
      </div>

      <section id="ranking-view" class="view ranking-view">
        <div class="ranking-header">
          <div>
            <p class="eyebrow">çµæœãƒšãƒ¼ã‚¸</p>
            <h2>ğŸ† ã¿ã‚“ãªã®ç¾åœ¨ã®é †ä½</h2>
            <p class="section-lead">æœ€æ–°ã®Pté †ã§ã€ä¸Šä½5ã¤ã®å•†å“åã¨ãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’ç”»åƒä»˜ãã§è¡¨ç¤ºã—ã¾ã™ã€‚</p>
          </div>
          <button class="close-tab-btn" id="close-tab-btn">ã“ã®ç”»é¢ã‚’é–‰ã˜ã‚‹</button>
        </div>
        <div class="maker-highlight" id="maker-highlight">
          <div class="maker-highlight-header">
            <span class="pill accent">ã“ã®ã¾ã¾ã„ãã¨â€¦</span>
            <div>
              <p class="maker-highlight-meta" id="maker-highlight-meta"></p>
              <h3 class="maker-highlight-title" id="maker-highlight-title"></h3>
            </div>
          </div>
          <div class="maker-highlight-body">
            <div id="maker-highlight-image"></div>
            <p class="section-lead" id="maker-highlight-description"></p>
          </div>
        </div>
        <div class="status" id="ranking-status">æœ€æ–°ã®é †ä½ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
        <div id="ranking-list" class="ranking-grid"></div>
      </section>
    </div>

    <script>
      const state = {
        categories: [],
        selectedCategory: null,
        selectedProducts: [null, null, null],
        activeRank: 0,
        questionAnswers: {
          now: '',
          hot: '',
        },
        activeQuestion: 'now',
      };
      const dragState = {
        source: null,
        product: null,
        fromIndex: null,
      };
      const FALLBACK_IMAGE =
        'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="360" height="240" viewBox="0 0 360 240"><rect width="360" height="240" fill="%23f2f4f7"/><rect x="30" y="30" width="300" height="180" rx="12" fill="none" stroke="%23c3cad4" stroke-width="8"/><path d="M96 166l48-58 48 58 48-72 24 32" fill="none" stroke="%23c3cad4" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/><circle cx="138" cy="90" r="22" fill="%23d8dde5"/></svg>';
      const RANK_POINTS = [3, 2, 1];

      const els = {
        tabs: document.getElementById('category-tabs'),
        productGrid: document.getElementById('product-grid'),
        count: document.getElementById('product-count'),
        status: document.getElementById('status'),
        submit: document.getElementById('submit-btn'),
        rankList: document.getElementById('rank-list'),
        formView: document.getElementById('form-view'),
        rankingView: document.getElementById('ranking-view'),
        rankingStatus: document.getElementById('ranking-status'),
        rankingList: document.getElementById('ranking-list'),
        closeTabBtn: document.getElementById('close-tab-btn'),
        makerHighlight: document.getElementById('maker-highlight'),
        makerHighlightMeta: document.getElementById('maker-highlight-meta'),
        makerHighlightTitle: document.getElementById('maker-highlight-title'),
        makerHighlightImage: document.getElementById('maker-highlight-image'),
        makerHighlightDescription: document.getElementById('maker-highlight-description'),
        questionTabs: document.getElementById('question-tabs'),
        questionPanels: document.getElementById('question-panels'),
        answerNow: document.getElementById('answer-now'),
        answerHot: document.getElementById('answer-hot'),
      };

      const viewState = { current: 'form' };

      function setStatus(message, isError = false) {
        els.status.textContent = message || '';
        els.status.classList.toggle('error', Boolean(isError));
      }

      function setRankingStatus(message, isError = false) {
        if (!els.rankingStatus) return;
        els.rankingStatus.textContent = message || '';
        els.rankingStatus.classList.toggle('error', Boolean(isError));
      }

      function switchView(target) {
        viewState.current = target;
        els.formView.classList.toggle('active', target === 'form');
        els.rankingView.classList.toggle('active', target === 'ranking');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function setActiveQuestionTab(key) {
        state.activeQuestion = key;
        if (els.questionTabs) {
          els.questionTabs.querySelectorAll('.question-tab').forEach((tab) => {
            tab.classList.toggle('active', tab.dataset.key === key);
          });
        }
        if (els.questionPanels) {
          els.questionPanels.querySelectorAll('.question-panel').forEach((panel) => {
            panel.classList.toggle('active', panel.dataset.key === key);
          });
        }
      }

      function createImageElement(src, alt) {
        const wrapper = document.createElement('div');
        wrapper.className = 'media-frame';

        const img = document.createElement('img');
        img.loading = 'lazy';
        img.alt = alt || 'image preview';
        img.referrerPolicy = 'no-referrer';

        const applyFallback = () => {
          img.onerror = null;
          img.src = FALLBACK_IMAGE;
        };

        img.onerror = applyFallback;
        img.src = src || FALLBACK_IMAGE;

        wrapper.appendChild(img);
        return wrapper;
      }

      function resetDragState() {
        dragState.source = null;
        dragState.product = null;
        dragState.fromIndex = null;
        if (els.rankList) {
          els.rankList.querySelectorAll('.rank-item').forEach((row) => row.classList.remove('drag-over'));
        }
      }

      function startCatalogDrag(event, item) {
        dragState.source = 'catalog';
        dragState.product = item;
        dragState.fromIndex = null;
        if (event?.dataTransfer) {
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', `${item.category}:${item.product}`);
        }
      }

      function startRankDrag(event, index) {
        const product = state.selectedProducts[index];
        if (!product) return;
        dragState.source = 'rank';
        dragState.product = product;
        dragState.fromIndex = index;
        if (event?.dataTransfer) {
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', `${product.category}:${product.product}`);
        }
      }

      function handleRankDragOver(event) {
        event.preventDefault();
        event.dataTransfer && (event.dataTransfer.dropEffect = 'move');
        event.currentTarget.classList.add('drag-over');
      }

      function handleRankDragLeave(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('drag-over');
      }

      function handleRankDrop(event, index) {
        event.preventDefault();
        event.currentTarget.classList.remove('drag-over');
        if (!dragState.product) return;

        if (dragState.source === 'rank') {
          reorderSelectedProducts(dragState.fromIndex, index);
        } else {
          placeProductAtRank(dragState.product, index);
        }
        resetDragState();
      }

      function updateCount() {
        const filled = state.selectedProducts.filter(Boolean).length;
        els.count.textContent = `${filled}/3`;
      }

      function updateProductSelections() {
        const cards = els.productGrid.querySelectorAll('.product-card');
        cards.forEach((card) => {
          const { category, product } = card.dataset;
          const rankIndex = state.selectedProducts.findIndex(
            (p) => p && p.category === category && p.product === product
          );
          const hasRank = rankIndex >= 0;
          card.classList.toggle('selected', hasRank);

          let rankBadge = card.querySelector('.rank-badge');
          if (hasRank) {
            if (!rankBadge) {
              rankBadge = document.createElement('span');
              rankBadge.className = 'rank-badge';
              card.insertBefore(rankBadge, card.firstChild);
            }
            rankBadge.textContent = `${rankIndex + 1}ä½ / ${RANK_POINTS[rankIndex]}pt`;
          } else if (rankBadge) {
            rankBadge.remove();
          }
        });
        updateCount();
      }

      function renderTabs() {
        els.tabs.innerHTML = '';
        state.categories.forEach((cat, idx) => {
          const button = document.createElement('button');
          button.className = 'tab' + (state.selectedCategory === cat.name || (!state.selectedCategory && idx === 0) ? ' active' : '');
          button.textContent = cat.name;
          button.addEventListener('click', () => {
            state.selectedCategory = cat.name;
            renderTabs();
            renderProducts();
          });
          els.tabs.appendChild(button);
        });
        if (!state.selectedCategory && state.categories.length) {
          state.selectedCategory = state.categories[0].name;
        }
      }

      function renderProducts() {
        els.productGrid.innerHTML = '';
        const category = state.categories.find((c) => c.name === state.selectedCategory);
        if (!category || !category.items.length) {
          delete els.productGrid.dataset.category;
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã¯å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
          els.productGrid.appendChild(empty);
          updateCount();
          return;
        }

        els.productGrid.dataset.category = category.name;
        category.items.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'card product-card';
          card.dataset.category = item.category;
          card.dataset.product = item.product;

          const img = createImageElement(item.imageUrl, item.product);
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = item.category;

          const meta = document.createElement('div');
          meta.className = 'meta';
          const maker = document.createElement('span');
          maker.className = 'maker';
          maker.textContent = item.maker || 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜';
          const price = document.createElement('span');
          price.className = 'price';
          price.textContent = item.price || '';
          meta.appendChild(maker);
          meta.appendChild(price);

          const title = document.createElement('h4');
          title.textContent = item.product;

          card.appendChild(img);
          card.appendChild(badge);
          card.appendChild(meta);
          card.appendChild(title);

          card.draggable = true;
          card.addEventListener('dragstart', (event) => startCatalogDrag(event, item));
          card.addEventListener('dragend', resetDragState);
          card.addEventListener('click', () => assignProductToActiveRank(item));
          els.productGrid.appendChild(card);
        });

        updateProductSelections();
      }

      function placeProductAtRank(item, targetIndex) {
        if (!item) return;
        const index = typeof targetIndex === 'number' ? targetIndex : 0;
        const products = [...state.selectedProducts];
        const duplicateIndex = products.findIndex((p) => p && p.category === item.category && p.product === item.product);

        if (duplicateIndex >= 0 && duplicateIndex !== index) {
          products[duplicateIndex] = null;
        }

        products[index] = { ...item, selectedAt: Date.now() };
        state.selectedProducts = products.slice(0, 3);
        state.activeRank = index;
        updateProductSelections();
        renderRankList();
      }

      function reorderSelectedProducts(fromIndex, toIndex) {
        if (fromIndex === toIndex || fromIndex == null || toIndex == null) return;
        const products = [...state.selectedProducts];
        const [moving] = products.splice(fromIndex, 1);
        if (!moving) return;
        products.splice(toIndex, 0, moving);
        while (products.length < 3) products.push(null);
        state.selectedProducts = products.slice(0, 3);
        state.activeRank = toIndex;
        updateProductSelections();
        renderRankList();
      }

      function assignProductToActiveRank(item) {
        const emptyIndex = state.selectedProducts.findIndex((p) => !p);
        const activeIndex = typeof state.activeRank === 'number' ? state.activeRank : 0;
        const targetIndex = emptyIndex >= 0 && state.selectedProducts[activeIndex] ? emptyIndex : activeIndex;
        placeProductAtRank(item, targetIndex);
      }

      function renderRankList() {
        if (!els.rankList) return;
        els.rankList.innerHTML = '';

        const labels = ['1ä½ (3pt)', '2ä½ (2pt)', '3ä½ (1pt)'];
        state.selectedProducts.forEach((item, idx) => {
          const row = document.createElement('div');
          row.className = 'rank-item' + (state.activeRank === idx ? ' active' : '');
          row.dataset.index = idx;
          row.addEventListener('dragover', handleRankDragOver);
          row.addEventListener('dragenter', handleRankDragOver);
          row.addEventListener('dragleave', handleRankDragLeave);
          row.addEventListener('drop', (event) => handleRankDrop(event, idx));
          row.addEventListener('click', () => {
            state.activeRank = idx;
            renderRankList();
          });

          const label = document.createElement('div');
          label.className = 'rank-label';
          label.textContent = labels[idx];

          const content = document.createElement('div');
          content.className = 'rank-content';

          if (item) {
            const title = document.createElement('div');
            title.textContent = item.product;
            const meta = document.createElement('div');
            meta.className = 'muted';
            meta.textContent = `${item.category} / ${item.maker || 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜'} / ${item.price || ''}`;
            content.appendChild(title);
            content.appendChild(meta);

            row.draggable = true;
            row.addEventListener('dragstart', (event) => startRankDrag(event, idx));
            row.addEventListener('dragend', resetDragState);
          } else {
            const empty = document.createElement('div');
            empty.className = 'rank-empty';
            empty.textContent = 'æœªé¸æŠ';
            content.appendChild(empty);
            row.removeAttribute('draggable');
          }

          row.appendChild(label);
          row.appendChild(content);
          els.rankList.appendChild(row);
        });
        updateCount();
      }

      function handleSubmit() {
        setStatus('');
        els.submit.disabled = true;

        const filledProducts = state.selectedProducts.filter(Boolean);
        if (filledProducts.length !== 3) {
          setStatus('æ¨ã—ãƒ‰ãƒªãƒ³ã‚¯TOP3ã‚’3ã¤é¸ã‚“ã§ã€1ä½ã‹ã‚‰3ä½ã¾ã§é †ä½ã‚’ã¤ã‘ã¦ãã ã•ã„ã€‚', true);
          els.submit.disabled = false;
          return;
        }

        const nowAnswer = (state.questionAnswers.now || '').trim();
        const hotAnswer = (state.questionAnswers.hot || '').trim();
        if (!nowAnswer || !hotAnswer) {
          setStatus('ã€Œä»Šé£²ã¿ãŸã„ã‚‚ã®ã€ã¨ã€Œä»Šæ—¥ãŒ40åº¦ã®æš‘ã„æ—¥ã ã¨ã—ã¦é£²ã¿ãŸã„ã‚‚ã®ã€ã®ä¸¡æ–¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
          els.submit.disabled = false;
          return;
        }

        const payload = {
          selectedProducts: state.selectedProducts.map((p) => {
            if (!p) return null;
            const { selectedAt, ...rest } = p;
            return rest;
          }),
          questionAnswers: {
            now: nowAnswer,
            hotDay: hotAnswer,
          },
        };

        google.script.run
          .withSuccessHandler(() => {
            setStatus('ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ã¿ã‚“ãªã®æ¨ã—TOP3ã‚’é›†è¨ˆã—ã¾ã™ã€‚');
            state.selectedProducts = [null, null, null];
            state.activeRank = 0;
            state.questionAnswers = { now: '', hot: '' };
            state.activeQuestion = 'now';
            setActiveQuestionTab('now');
            if (els.answerNow) els.answerNow.value = '';
            if (els.answerHot) els.answerHot.value = '';
            renderProducts();
            renderRankList();
            els.submit.disabled = false;
            fetchRankingSummary();
          })
          .withFailureHandler((err) => {
            setStatus(err?.message || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
            els.submit.disabled = false;
          })
          .submitResponse(payload);
      }

      function fetchRankingSummary() {
        if (!els.rankingStatus || !els.rankingList) return;
        setRankingStatus('æœ€æ–°ã®é †ä½ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
        els.rankingList.innerHTML = '';
        switchView('ranking');

        google.script.run
          .withSuccessHandler((data) => {
            const products = Array.isArray(data?.products) ? data.products : Array.isArray(data) ? data : [];
            const makerLeader = !Array.isArray(data) ? data?.makerLeader : null;
            renderMakerHighlight(makerLeader);
            renderRankingList(products);
            setRankingStatus(products.length ? '' : 'ã¾ã é›†è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¥¨ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚');
          })
          .withFailureHandler((err) => {
            setRankingStatus(err?.message || 'é †ä½ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
          })
          .getRankingSummary();
      }

      function renderRankingList(items) {
        els.rankingList.innerHTML = '';
        const topItems = Array.isArray(items) ? items.slice(0, 5) : [];
        if (!topItems.length) return;

        topItems.forEach((item, idx) => {
          const card = document.createElement('div');
          card.className = 'ranking-card';

          const rank = document.createElement('div');
          rank.className = 'ranking-rank';
          rank.innerHTML = `<span>${idx + 1} ä½</span><span class="pts">${item.points || 0} Pt</span>`;

          const img = createImageElement(item.imageUrl, item.product);

          const title = document.createElement('h4');
          title.textContent = item.product || 'å•†å“åä¸æ˜';

          const meta = document.createElement('div');
          meta.className = 'ranking-meta';
          const maker = document.createElement('span');
          maker.textContent = item.maker || 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜';
          const count = document.createElement('span');
          count.textContent = `${item.count || 0} ç¥¨`;
          meta.appendChild(maker);
          meta.appendChild(count);

          const category = document.createElement('div');
          category.className = 'muted';
          const priceLabel = item.price ? ` / ${item.price}` : '';
          category.textContent = `${item.category || 'ã‚«ãƒ†ã‚´ãƒªä¸æ˜'}${priceLabel}`;

          card.appendChild(rank);
          card.appendChild(img);
          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(category);

          els.rankingList.appendChild(card);
        });
      }

      function renderMakerHighlight(maker) {
        if (!els.makerHighlight || !els.makerHighlightImage || !els.makerHighlightMeta || !els.makerHighlightTitle || !els.makerHighlightDescription) {
          return;
        }
        els.makerHighlight.classList.remove('visible');
        els.makerHighlightImage.innerHTML = '';
        els.makerHighlightMeta.textContent = '';
        els.makerHighlightTitle.textContent = '';
        els.makerHighlightDescription.textContent = '';

        if (!maker || (!maker.maker && !maker.imageUrl)) return;

        const name = maker.maker || 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜';
        const points = Number(maker.points || 0);
        const votes = Number(maker.count || 0);
        const imageUrl = maker.imageUrl || '';

        const metaParts = [];
        if (points) metaParts.push(`åˆè¨ˆ ${points} Pt`);
        if (votes) metaParts.push(`${votes} ç¥¨`);

        els.makerHighlightMeta.textContent = metaParts.join(' / ') || 'é›†è¨ˆä¸­...';
        els.makerHighlightTitle.textContent = `${name} ãŒãƒ¡ãƒ¼ã‚«ãƒ¼Pt 1ä½ï¼`;
        els.makerHighlightDescription.textContent = `ã“ã®ã¾ã¾ã„ãã¨â€¦ ${name} ã®è‡ªè²©æ©ŸãŒé¸ã°ã‚Œãã†ã§ã™ã€‚`;

        const image = createImageElement(imageUrl || FALLBACK_IMAGE, name);
        els.makerHighlightImage.appendChild(image);
        els.makerHighlight.classList.add('visible');
      }

      function setupQuestionInputs() {
        setActiveQuestionTab(state.activeQuestion);
        if (els.questionTabs) {
          els.questionTabs.querySelectorAll('.question-tab').forEach((tab) => {
            tab.addEventListener('click', () => {
              const key = tab.dataset.key || 'now';
              setActiveQuestionTab(key);
            });
          });
        }
        if (els.answerNow) {
          els.answerNow.addEventListener('input', (event) => {
            state.questionAnswers.now = event.target.value;
          });
        }
        if (els.answerHot) {
          els.answerHot.addEventListener('input', (event) => {
            state.questionAnswers.hot = event.target.value;
          });
        }
      }

      function closeTab() {
        window.close();
      }

      function load() {
        setStatus('èª­ã¿è¾¼ã¿ä¸­...');
        setupQuestionInputs();
        if (typeof google === 'undefined' || !google.script?.run) {
          setStatus('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚Apps Script ç’°å¢ƒã§ãŠè©¦ã—ãã ã•ã„ã€‚', true);
          els.submit.disabled = true;
          return;
        }

        google.script.run
          .withSuccessHandler((data) => {
            state.categories = data.categories || [];
            renderTabs();
            renderProducts();
            renderRankList();
            setStatus('');
          })
          .withFailureHandler((err) => {
            setStatus(err?.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ«ãƒ€ã®æ¨©é™ã‚„IDã‚’ã”ç¢ºèªãã ã•ã„ã€‚', true);
          })
          .getInitialData();
      }

      els.submit.addEventListener('click', handleSubmit);
      if (els.closeTabBtn) {
        els.closeTabBtn.addEventListener('click', closeTab);
      }
      document.addEventListener('DOMContentLoaded', load);
    </script>
  </body>
</html>
