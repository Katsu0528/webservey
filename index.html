<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è‡ªå‹•è²©å£²æ©Ÿã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
    <style>
      @import url('https://fonts.googleapis.com/css2?family=Baloo+2:wght@500;600&family=Noto+Sans+JP:wght@400;500;700&display=swap');

      :root {
        --accent: #ff7eb6;
        --accent-2: #6c8cff;
        --border: #e5e7f0;
        --muted: #f7f8ff;
        --text: #1f2430;
        --shadow: 0 12px 28px rgba(61, 78, 255, 0.08);
      }

      body {
        margin: 0;
        font-family: 'Noto Sans JP', 'Baloo 2', system-ui, -apple-system, sans-serif;
        background: radial-gradient(circle at 10% 20%, #fff3fb 0, #f1f6ff 45%, #ffffff 90%);
        color: var(--text);
      }

      .page {
        max-width: 1040px;
        margin: 0 auto;
        padding: 28px 16px 60px;
      }

      h1 {
        font-size: 30px;
        margin: 0 0 12px;
        letter-spacing: 0.02em;
      }

      h2 {
        margin: 4px 0 6px;
      }

      p.lead {
        margin: 0 0 18px;
        color: #3a3f52;
        line-height: 1.7;
      }

      header.hero {
        background: linear-gradient(120deg, rgba(255, 126, 182, 0.12), rgba(108, 140, 255, 0.12));
        border: 1px solid var(--border);
        border-radius: 20px;
        padding: 22px 20px 20px;
        box-shadow: var(--shadow);
      }

      .hero-badges {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        margin-bottom: 8px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        background: #fff;
        color: var(--text);
        border: 1px solid var(--border);
        padding: 6px 12px;
        border-radius: 999px;
        font-weight: 600;
      }

      .pill.accent {
        background: #1f1f1f;
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      }

      .pill.alt {
        background: #fff1f8;
        color: #ff4f9d;
        border-color: #ffd7eb;
      }

      section {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px 16px 20px;
        margin-top: 16px;
        box-shadow: var(--shadow);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
      }

      .section-lead {
        margin: 0;
        color: #4a5066;
        line-height: 1.6;
        font-size: 14px;
      }

      .eyebrow {
        text-transform: uppercase;
        letter-spacing: 0.06em;
        font-weight: 700;
        color: #8b92b2;
        font-size: 12px;
        margin: 0;
      }

      .counter {
        background: linear-gradient(120deg, #ffd7eb, #dfe3ff);
        color: #2c2c54;
        padding: 10px 14px;
        border-radius: 14px;
        font-weight: 700;
        min-width: 86px;
        text-align: center;
        box-shadow: var(--shadow);
      }

      .category-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 12px 0 8px;
      }

      .tab {
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 12px;
        padding: 8px 14px;
        cursor: pointer;
        transition: 0.15s;
        font-weight: 700;
        color: #2e2f44;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.03);
      }

      .tab.active {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        border-color: transparent;
        box-shadow: 0 8px 20px rgba(255, 126, 182, 0.35);
      }

      .card-grid {
        display: grid;
        gap: 14px;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 10px;
        background: #fff;
        transition: 0.18s;
        cursor: pointer;
        display: flex;
        flex-direction: column;
        gap: 8px;
        position: relative;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.03);
      }

      .card:hover {
        box-shadow: 0 14px 30px rgba(0, 0, 0, 0.1);
        transform: translateY(-3px);
      }

      .card.disabled {
        filter: grayscale(0.6);
        opacity: 0.5;
        pointer-events: none;
      }

      .card.selected {
        border: 2px solid var(--accent);
        box-shadow: 0 16px 28px rgba(255, 126, 182, 0.26);
      }

      .vendor-card.dimmed {
        filter: grayscale(0.5);
        opacity: 0.45;
      }

      .media-frame {
        width: 100%;
        height: 160px;
        border-radius: 12px;
        background: linear-gradient(145deg, #fdf3ff, #f0f5ff);
        border: 1px solid var(--border);
        overflow: hidden;
      }

      .media-frame iframe {
        width: 100%;
        height: 100%;
        border: 0;
        background: transparent;
        pointer-events: none;
      }

      .card h4 {
        margin: 0;
        font-size: 15px;
      }

      .card .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #555;
        gap: 8px;
      }

      .card .maker {
        font-weight: 700;
        color: #34354a;
      }

      textarea {
        width: 100%;
        min-height: 140px;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 15px;
        resize: vertical;
        box-sizing: border-box;
        background: #fff;
      }

      .actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-top: 18px;
        flex-wrap: wrap;
      }

      button.primary {
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        color: #fff;
        border: none;
        border-radius: 14px;
        padding: 12px 22px;
        font-size: 15px;
        cursor: pointer;
        box-shadow: 0 14px 26px rgba(255, 126, 182, 0.35);
        transition: 0.18s;
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      button.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .status {
        font-size: 14px;
        color: #3c3d52;
        padding: 10px 12px;
        background: #f8f9ff;
        border: 1px solid var(--border);
        border-radius: 12px;
        min-height: 20px;
      }

      .status.error {
        background: #fff5f8;
        color: #d6266f;
        border-color: #ffc0d7;
      }

      .badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #fff;
        color: var(--accent);
        padding: 4px 8px;
        border-radius: 10px;
        border: 1px solid var(--accent);
        font-weight: 700;
        font-size: 12px;
      }

      .muted {
        color: #666;
      }

      .empty {
        padding: 14px;
        background: var(--muted);
        border-radius: 10px;
        text-align: center;
      }

      .note {
        color: #4b4f65;
        background: #fdf3ff;
        border: 1px dashed #ffc0df;
        padding: 10px 12px;
        border-radius: 12px;
        margin: 6px 0 10px;
      }

      .alert {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #ffc0d7;
        background: #fff5f8;
        color: #c22463;
        display: none;
      }

      .alert.visible {
        display: block;
      }

      @media (max-width: 600px) {
        h1 {
          font-size: 24px;
        }
        .media-frame {
          height: 140px;
        }
      }
    </style>
  </head>
  <body>
    <div class="page">
      <header class="hero">
        <div class="hero-badges">
          <span class="pill accent">New Office Break Time</span>
          <span class="pill alt">ã¿ã‚“ãªã§æŠ•ç¥¨</span>
        </div>
        <h1>ğŸ‰ æ–°ã‚ªãƒ•ã‚£ã‚¹ã®è‡ªè²©æ©Ÿã€ã¿ã‚“ãªã§æ±ºã‚ã¡ã‚ƒãŠã†!</h1>
        <p class="lead">
          æ–°ã—ã„ã‚ªãƒ•ã‚£ã‚¹ã«è¨­ç½®ã™ã‚‹è‡ªè²©æ©Ÿã‚’ã€ã‚ãªãŸã®ä¸€ç¥¨ã§æ±ºå®šã—ã¾ã™! æ¯æ—¥ã®ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ã‚’æœ€é«˜ã«ã™ã‚‹ãŸã‚ã€ã¿ã‚“ãªã®ã€Œé£²ã¿ãŸã„!ã€ã‚’æ•™ãˆã¦ãã ã•ã„âœ¨
        </p>
        <div class="hero-badges">
          <span class="pill">ç”»åƒã‚’ãƒãƒãƒƒã¨æŠ¼ã™ã ã‘</span>
          <span class="pill">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«ã‚«ã‚¦ãƒ³ãƒˆ</span>
          <span class="pill">è‡ªç”±è¨˜å…¥ã‚‚å¤§æ­“è¿</span>
        </div>
      </header>

      <section id="q1">
        <div class="section-header">
          <div>
            <p class="eyebrow">STEP 1</p>
            <h2>â˜• ã‚ãªãŸã®æ¨ã—ãƒ‰ãƒªãƒ³ã‚¯TOP3ã‚’æ•™ãˆã¦!</h2>
            <p class="section-lead">
              ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸ã¶ã¨ã€ã‚ºãƒ©ãƒªã¨å•†å“ãŒç™»å ´! ç”»åƒã‚’ãƒãƒãƒƒã¨æŠ¼ã—ã¦ã€ãŠæ°—ã«å…¥ã‚Šã‚’3ã¤ã¾ã§é¸ã‚“ã§ãã ã•ã„ã­ã€‚
              <br />ï¼ˆã‚‚ã†ä¸€åº¦æŠ¼ã™ã¨è§£é™¤ã§ãã¾ã™ï¼‰
            </p>
          </div>
          <div class="counter" id="product-count">0/3</div>
        </div>
        <div class="note">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¿ãƒ–ã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨ã€ãã®ã‚«ãƒ†ã‚´ãƒªã®ãƒ‰ãƒªãƒ³ã‚¯ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</div>
        <div class="category-tabs" id="category-tabs"></div>
        <div id="product-grid" class="card-grid"></div>
      </section>

      <section id="q2">
        <div class="section-header">
          <div>
            <p class="eyebrow">STEP 2</p>
            <h2>ğŸª ç›¸æ£’ã«ãªã‚‹è‡ªè²©æ©Ÿãƒ¡ãƒ¼ã‚«ãƒ¼ã¯?</h2>
            <p class="section-lead">
              ãƒ‡ã‚¶ã‚¤ãƒ³? å“æƒãˆ? ãã‚Œã¨ã‚‚ä½¿ã„ã‚„ã™ã•? ãƒ”ãƒ³ã¨ããŸ1å°ã‚’ç”»åƒã‚¯ãƒªãƒƒã‚¯ã§é¸ã‚“ã§ãã ã•ã„!
              <br />ï¼ˆæ°—ãŒå¤‰ã‚ã£ãŸã‚‰ã€ã‚‚ã†ä¸€åº¦ã‚¯ãƒªãƒƒã‚¯ã§é¸ã³ç›´ã›ã¾ã™ï¼‰
            </p>
          </div>
        </div>
        <div class="alert" id="vendor-alert"></div>
        <div id="vendor-grid" class="card-grid vendor-grid"></div>
      </section>

      <section id="q3">
        <p class="eyebrow">STEP 3</p>
        <h2>ğŸ’­ ã‚ãªãŸã®ã€Œã“ã‚“ãªè‡ªè²©æ©Ÿã ã£ãŸã‚‰æœ€é«˜!ã€ã‚’èã‹ã›ã¦ (ä»»æ„)</h2>
        <textarea
          id="free-text"
          placeholder="ã€Œã“ã®å¹»ã®ãƒ‰ãƒªãƒ³ã‚¯ã‚’å…¥ã‚Œã¦ã»ã—ã„!ã€ã€Œ100å††å°ã®å•†å“ã‚’å……å®Ÿã•ã›ã¦!ã€ãªã©ã€å¤¢ã‚„å¸Œæœ›ã€ãªã‚“ã§ã‚‚OK! è‡ªç”±ã«ã”è¨˜å…¥ãã ã•ã„ğŸ¤"
        ></textarea>
      </section>

      <div class="actions">
        <button class="primary" id="submit-btn">ã“ã®å†…å®¹ã§é€ä¿¡ã™ã‚‹ ğŸš€</button>
        <div class="status" id="status"></div>
      </div>
    </div>

    <script>
      const state = {
        categories: [],
        selectedCategory: null,
        selectedProducts: [],
        vendorImages: [],
        selectedVendor: null,
        vendorError: '',
      };
      const FALLBACK_IMAGE =
        'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="360" height="240" viewBox="0 0 360 240"><rect width="360" height="240" fill="%23f2f4f7"/><rect x="30" y="30" width="300" height="180" rx="12" fill="none" stroke="%23c3cad4" stroke-width="8"/><path d="M96 166l48-58 48 58 48-72 24 32" fill="none" stroke="%23c3cad4" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/><circle cx="138" cy="90" r="22" fill="%23d8dde5"/></svg>';

      const els = {
        tabs: document.getElementById('category-tabs'),
        productGrid: document.getElementById('product-grid'),
        vendorGrid: document.getElementById('vendor-grid'),
        count: document.getElementById('product-count'),
        status: document.getElementById('status'),
        submit: document.getElementById('submit-btn'),
        freeText: document.getElementById('free-text'),
        vendorAlert: document.getElementById('vendor-alert'),
      };

      function setStatus(message, isError = false) {
        els.status.textContent = message || '';
        els.status.classList.toggle('error', Boolean(isError));
      }

      function createImageElement(src, alt) {
        const wrapper = document.createElement('div');
        wrapper.className = 'media-frame';

        const iframe = document.createElement('iframe');
        iframe.title = alt || 'image preview';
        iframe.loading = 'lazy';
        iframe.referrerPolicy = 'no-referrer';

        const applyFallback = () => {
          if (iframe.dataset.fallbackApplied) return;
          iframe.dataset.fallbackApplied = 'true';
          iframe.srcdoc = `
            <style>
              html,body {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                background: linear-gradient(145deg, #fdf3ff, #f0f5ff);
                font-family: 'Noto Sans JP', system-ui, sans-serif;
                color: #6b7280;
              }
              img {
                max-width: 90%;
                max-height: 90%;
                object-fit: contain;
              }
            </style>
            <img src="${FALLBACK_IMAGE}" alt="ç”»åƒã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ" />
          `;
        };

        if (src) {
          iframe.src = src;
        } else {
          applyFallback();
        }

        iframe.addEventListener('error', applyFallback);
        wrapper.appendChild(iframe);
        return wrapper;
      }

      function updateCount() {
        els.count.textContent = `${state.selectedProducts.length}/3`;
        const limitReached = state.selectedProducts.length >= 3;
        document.querySelectorAll('.product-card').forEach((card) => {
          if (limitReached && !card.classList.contains('selected')) {
            card.classList.add('disabled');
          } else {
            card.classList.remove('disabled');
          }
        });
      }

      function renderTabs() {
        els.tabs.innerHTML = '';
        state.categories.forEach((cat, idx) => {
          const button = document.createElement('button');
          button.className = 'tab' + (state.selectedCategory === cat.name || (!state.selectedCategory && idx === 0) ? ' active' : '');
          button.textContent = cat.name;
          button.addEventListener('click', () => {
            state.selectedCategory = cat.name;
            renderTabs();
            renderProducts();
          });
          els.tabs.appendChild(button);
        });
        if (!state.selectedCategory && state.categories.length) {
          state.selectedCategory = state.categories[0].name;
        }
      }

      function renderProducts() {
        els.productGrid.innerHTML = '';
        const category = state.categories.find((c) => c.name === state.selectedCategory);
        if (!category || !category.items.length) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã¯å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
          els.productGrid.appendChild(empty);
          updateCount();
          return;
        }

        category.items.forEach((item) => {
          const card = document.createElement('div');
          card.className = 'card product-card';

          if (state.selectedProducts.some((p) => p.category === item.category && p.product === item.product)) {
            card.classList.add('selected');
          }

          const img = createImageElement(item.imageUrl, item.product);
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = item.category;

          const meta = document.createElement('div');
          meta.className = 'meta';
          const maker = document.createElement('span');
          maker.className = 'maker';
          maker.textContent = item.maker || 'ãƒ¡ãƒ¼ã‚«ãƒ¼ä¸æ˜';
          const price = document.createElement('span');
          price.textContent = item.price || '';
          meta.appendChild(maker);
          meta.appendChild(price);

          const title = document.createElement('h4');
          title.textContent = item.product;

          card.appendChild(img);
          card.appendChild(badge);
          card.appendChild(meta);
          card.appendChild(title);

          card.addEventListener('click', () => toggleProduct(item, card));
          els.productGrid.appendChild(card);
        });

        updateCount();
      }

      function toggleProduct(item, card) {
        const exists = state.selectedProducts.findIndex(
          (p) => p.category === item.category && p.product === item.product
        );

        if (exists >= 0) {
          state.selectedProducts.splice(exists, 1);
          card.classList.remove('selected');
        } else if (state.selectedProducts.length < 3) {
          state.selectedProducts.push(item);
          card.classList.add('selected');
        }
        updateCount();
      }

      function renderVendors() {
        els.vendorGrid.innerHTML = '';
        renderVendorAlert();
        if (!state.vendorImages.length) {
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = state.vendorError || 'è‡ªè²©æ©Ÿãƒ¡ãƒ¼ã‚«ãƒ¼ç”»åƒãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚';
          els.vendorGrid.appendChild(empty);
          return;
        }

        state.vendorImages.forEach((vendor) => {
          const card = document.createElement('div');
          card.className = 'card vendor-card';
          if (state.selectedVendor && state.selectedVendor.id === vendor.id) {
            card.classList.add('selected');
          } else if (state.selectedVendor) {
            card.classList.add('dimmed');
          }

          const img = createImageElement(vendor.url, vendor.name);
          const title = document.createElement('h4');
          title.textContent = vendor.name;

          card.appendChild(img);
          card.appendChild(title);

          card.addEventListener('click', () => {
            if (state.selectedVendor && state.selectedVendor.id === vendor.id) {
              state.selectedVendor = null;
              card.classList.remove('selected');
            } else {
              state.selectedVendor = vendor;
              document.querySelectorAll('.vendor-card').forEach((c) => c.classList.remove('selected', 'dimmed'));
              card.classList.add('selected');
            }
            document.querySelectorAll('.vendor-card').forEach((c) => {
              if (state.selectedVendor && !c.classList.contains('selected')) {
                c.classList.add('dimmed');
              } else {
                c.classList.remove('dimmed');
              }
            });
          });

          els.vendorGrid.appendChild(card);
        });
      }

      function handleSubmit() {
        setStatus('');
        els.submit.disabled = true;

        if (state.selectedProducts.length === 0) {
          setStatus('æ¨ã—ãƒ‰ãƒªãƒ³ã‚¯ã‚’1ã¤ä»¥ä¸Šé¸ã‚“ã§ã­ï¼', true);
          els.submit.disabled = false;
          return;
        }

        if (!state.selectedVendor) {
          setStatus('ç›¸æ£’ã«ã™ã‚‹è‡ªè²©æ©Ÿãƒ¡ãƒ¼ã‚«ãƒ¼ã‚’1ã¤é¸ã‚“ã§ãã ã•ã„ã€‚', true);
          els.submit.disabled = false;
          return;
        }

        const payload = {
          selectedProducts: state.selectedProducts,
          vendorImage: state.selectedVendor,
          freeText: els.freeText.value.trim(),
        };

        google.script.run
          .withSuccessHandler(() => {
            setStatus('ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸï¼ã¿ã‚“ãªã®ãƒ–ãƒ¬ã‚¤ã‚¯ã‚¿ã‚¤ãƒ ãŒã‚‚ã£ã¨æ¥½ã—ããªã‚Šã¾ã™ã€‚');
            state.selectedProducts = [];
            state.selectedVendor = null;
            els.freeText.value = '';
            renderProducts();
            renderVendors();
            els.submit.disabled = false;
          })
          .withFailureHandler((err) => {
            setStatus(err?.message || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
            els.submit.disabled = false;
          })
          .submitResponse(payload);
      }

      function load() {
        setStatus('èª­ã¿è¾¼ã¿ä¸­...');
        if (typeof google === 'undefined' || !google.script?.run) {
          setStatus('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚Apps Script ç’°å¢ƒã§ãŠè©¦ã—ãã ã•ã„ã€‚', true);
          els.submit.disabled = true;
          return;
        }

        google.script.run
          .withSuccessHandler((data) => {
            state.categories = data.categories || [];
            state.vendorImages = data.vendorImages || [];
            state.vendorError = data.vendorError || '';
            renderTabs();
            renderProducts();
            renderVendors();
            setStatus('');
          })
          .withFailureHandler((err) => {
            setStatus(err?.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ«ãƒ€ã®æ¨©é™ã‚„IDã‚’ã”ç¢ºèªãã ã•ã„ã€‚', true);
          })
          .getInitialData();
      }

      function renderVendorAlert() {
        if (!els.vendorAlert) return;
        if (state.vendorError) {
          els.vendorAlert.textContent = state.vendorError;
          els.vendorAlert.classList.add('visible');
        } else {
          els.vendorAlert.textContent = '';
          els.vendorAlert.classList.remove('visible');
        }
      }

      els.submit.addEventListener('click', handleSubmit);
      document.addEventListener('DOMContentLoaded', load);
    </script>
  </body>
</html>
