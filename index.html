<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>è‡ªå‹•è²©å£²æ©Ÿã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --accent: #2563eb;
        --accent-2: #8b5cf6;
        --border: #e5e7eb;
        --muted: #f9fafb;
        --text: #111827;
        --subtext: #4b5563;
        --shadow: 0 10px 24px rgba(0, 0, 0, 0.06);
      }

      body {
        margin: 0;
        font-family: 'Noto Sans JP', system-ui, -apple-system, sans-serif;
        color: #111827;
        background: #f8fafc;
      }

      .page {
        max-width: 980px;
        margin: 0 auto;
        padding: 20px 14px 44px;
      }

      h1 {
        font-size: 26px;
        font-weight: 700;
        letter-spacing: 0.01em;
        margin: 0 0 8px;
      }

      h2 {
        font-size: 18px;
        font-weight: 700;
        margin: 0 0 6px;
      }

      .section-lead,
      p.lead {
        margin: 0 0 18px;
        color: #4b5563;
        line-height: 1.7;
      }

      header.hero {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px;
        box-shadow: var(--shadow);
      }

      .hero-badges {
        display: none;
      }

      .pill {
        display: none;
      }

      .pill.accent {
        background: #1f1f1f;
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      }

      .pill.alt {
        background: #fff1f8;
        color: #ff4f9d;
        border-color: #ffd7eb;
      }

      section {
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 18px 16px 20px;
        margin-top: 16px;
        box-shadow: var(--shadow);
      }

      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 12px;
        flex-wrap: wrap;
      }

      .section-header > div:first-child {
        position: relative;
        padding-left: 12px;
      }

      .section-header > div:first-child::before {
        content: '';
        position: absolute;
        left: 0;
        top: 6px;
        bottom: 6px;
        width: 3px;
        border-radius: 999px;
        background: linear-gradient(180deg, rgba(37, 99, 235, 0.8), rgba(37, 99, 235, 0.15));
      }

      .section-lead {
        margin: 0;
        color: var(--subtext);
        line-height: 1.7;
      }

      .eyebrow {
        display: none;
      }

      .counter {
        background: #fff;
        color: #374151;
        padding: 10px 14px;
        border-radius: 999px;
        font-weight: 700;
        min-width: 86px;
        text-align: center;
        border: 1px solid var(--border);
        box-shadow: none;
      }

      .category-tabs {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        margin: 12px 0 8px;
      }

      .tab {
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 999px;
        padding: 8px 14px;
        cursor: pointer;
        transition: 0.15s;
        font-weight: 700;
        color: #374151;
        box-shadow: none;
      }

      .tab.active {
        background: #eff6ff;
        border-color: #bfdbfe;
        color: #1d4ed8;
        box-shadow: none;
      }

      .vending-window {
        position: relative;
        padding: 14px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: none;
      }

      .vending-window::before {
        display: none;
      }

      .card-grid {
        position: relative;
        display: grid;
        gap: 10px;
        grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
        align-items: stretch;
      }

      .card {
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        background: #fff;
        transition: transform 0.15s, box-shadow 0.15s, border-color 0.15s;
        cursor: grab;
        display: flex;
        flex-direction: column;
        gap: 10px;
        position: relative;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
        align-items: center;
        text-align: center;
      }

      .card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 22px rgba(0, 0, 0, 0.08);
        border-color: #d1d5db;
      }

      .card.disabled {
        filter: grayscale(0.6);
        opacity: 0.5;
        pointer-events: none;
      }

      .card.selected {
        border: 2px solid rgba(47, 111, 237, 0.55);
        background: #f8fbff;
        box-shadow: 0 6px 16px rgba(47, 111, 237, 0.08);
      }

      .selection-layout {
        display: grid;
        grid-template-columns: 2.2fr 1fr;
        gap: 16px;
        align-items: start;
      }

      .vending-area {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .selection-panel {
        position: sticky;
        top: 16px;
        align-self: start;
        max-height: calc(100vh - 32px);
        border: 1px solid var(--border);
        border-radius: 16px;
        padding: 12px;
        background: #fff;
        box-shadow: var(--shadow);
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .selection-panel h3 {
        margin: 0;
        font-size: 16px;
      }

      .selection-panel__head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .selection-panel__body {
        overflow: auto;
        padding-right: 2px;
        flex: 1 1 auto;
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .selection-panel__footer {
        position: sticky;
        bottom: 0;
        background: #fff;
        padding-top: 10px;
        border-top: 1px solid var(--border);
      }

      .selection-panel__footer .primary {
        width: 100%;
      }

      .rank-list {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      #rank-list {
        display: grid;
        gap: 16px;
      }

      .rank-item {
        border: 1px dashed var(--border);
        border-radius: 16px;
        padding: 14px;
        display: flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        transition: border-color 0.15s, box-shadow 0.15s, background 0.15s;
      }

      .rank-item.active {
        border-color: rgba(47, 111, 237, 0.55);
        border-width: 2px;
        background: #f8fbff;
        box-shadow: 0 14px 28px rgba(0, 0, 0, 0.1);
      }

      .rank-item.drag-over {
        border-color: rgba(47, 111, 237, 0.55);
        background: #f8fbff;
        box-shadow: none;
      }

      .rank-label {
        font-weight: 900;
        color: #2e2f44;
        min-width: 92px;
        font-size: 18px;
      }

      .rank-thumb {
        width: 120px;
        height: 120px;
        border-radius: 16px;
        background: var(--muted);
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        flex-shrink: 0;
      }

      .rank-thumb img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      .rank-content {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 18px;
      }

      .rank-content > div:first-child {
        font-size: 20px;
        font-weight: 900;
        line-height: 1.25;
      }

      .rank-content .muted {
        font-size: 14px;
        color: #6b7280;
      }

      .rank-empty {
        color: var(--subtext);
        font-size: 18px;
      }

      .media-frame {
        width: 100%;
        aspect-ratio: 3 / 4;
        min-height: 160px;
        border-radius: 14px;
        background: var(--muted);
        border: 1px solid var(--border);
        overflow: hidden;
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
      }

      .media-frame iframe {
        width: 100%;
        height: 100%;
        border: 0;
        background: transparent;
        pointer-events: none;
      }

      .media-frame img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
        background: transparent;
      }

      .card h4 {
        margin: 0;
        font-size: 15px;
      }

      .card .meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: #555;
        gap: 8px;
        width: 100%;
      }

      .card .price {
        font-size: 16px;
        font-weight: 800;
        color: #1d4ed8;
      }

      .card .meta,
      .card h4 {
        width: 100%;
      }

      .card .maker {
        font-weight: 700;
        color: var(--text);
      }

      textarea {
        width: 100%;
        min-height: 140px;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid var(--border);
        font-size: 15px;
        resize: vertical;
        box-sizing: border-box;
        background: #fff;
      }

      .q2-controls {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        margin: 10px 0 8px;
      }

      .chip {
        border: 1px solid var(--border);
        background: #fff;
        border-radius: 999px;
        padding: 8px 12px;
        font-weight: 800;
        cursor: pointer;
        box-shadow: 0 6px 14px rgba(0, 0, 0, 0.04);
        transition: 0.15s;
      }

      .chip[aria-pressed='true'] {
        border-color: transparent;
        color: #fff;
        background: linear-gradient(120deg, var(--accent), var(--accent-2));
        box-shadow: 0 10px 22px rgba(108, 140, 255, 0.18);
      }

      .q2-hint {
        margin: 0;
        font-size: 13px;
        color: #64748b;
      }

      button.primary {
        background: var(--accent);
        color: #fff;
        border: none;
        border-radius: 12px;
        padding: 12px 18px;
        font-size: 15px;
        cursor: pointer;
        box-shadow: 0 10px 18px rgba(37, 99, 235, 0.22);
        transition: 0.18s;
        font-weight: 700;
        letter-spacing: 0.01em;
      }

      button.primary:hover {
        filter: brightness(0.97);
      }

      button.primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        box-shadow: none;
      }

      .status {
        font-size: 14px;
        color: var(--subtext);
        padding: 10px 12px;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 12px;
        min-height: 20px;
      }

      #status {
        display: none;
      }

      .status.error {
        background: #fff5f8;
        color: #d6266f;
        border-color: #ffc0d7;
      }

      #ranking-status {
        display: none;
      }

      #ranking-status.visible {
        display: block;
      }

      #ranking-status.status {
        border: none !important;
        background: transparent !important;
        padding: 0 !important;
        margin: 6px 0 0 !important;
        color: var(--subtext) !important;
        min-height: 0 !important;
      }

      .badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: #fff;
        color: var(--accent);
        padding: 4px 8px;
        border-radius: 10px;
        border: 1px solid var(--accent);
        font-weight: 700;
        font-size: 12px;
      }

      .rank-badge {
        position: absolute;
        top: 10px;
        left: 10px;
        background: var(--accent);
        color: #fff;
        padding: 4px 10px;
        border-radius: 10px;
        font-weight: 800;
        font-size: 12px;
        box-shadow: 0 6px 16px rgba(47, 111, 237, 0.2);
      }

      .muted {
        color: #666;
      }

      .empty {
        padding: 14px;
        background: var(--muted);
        border-radius: 10px;
        text-align: center;
      }

      .note {
        color: var(--subtext);
        background: var(--muted);
        border: 1px dashed #f2d5c2;
        padding: 10px 12px;
        border-radius: 12px;
        margin: 6px 0 10px;
      }

      .alert {
        margin-top: 10px;
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid #ffc0d7;
        background: #fff5f8;
        color: #c22463;
        display: none;
      }

      .alert.visible {
        display: block;
      }

      .view {
        display: none;
      }

      .view.active {
        display: block;
      }

      .ranking-view {
        margin-top: 16px;
      }

      .ranking-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }

      .ranking-note {
        font-size: 13px;
        color: #6b7280;
        background: #f8fafc;
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 8px 12px;
        margin-top: 6px;
      }

      .ranking-layout {
        display: flex;
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
        margin-top: 14px;
      }

      .ranking-results {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      /* ===== Result TOP3 Podium ===== */
      #ranking-view .ranking-top3 {
        margin: 12px 0 18px;
      }

      #ranking-view .podium {
        display: grid;
        grid-template-columns: 1fr 1.15fr 1fr;
        gap: 14px;
        align-items: end;
      }

      #ranking-view .podium-card {
        border-radius: 22px;
        border: 1px solid var(--border);
        background: #fff;
        box-shadow: 0 16px 34px rgba(0, 0, 0, 0.08);
        padding: 14px;
        display: grid;
        gap: 10px;
      }

      #ranking-view .podium-card.place-1 {
        transform: translateY(-10px);
        border-width: 2px;
        border-color: #fbbf24;
        background: linear-gradient(180deg, #fff7ed, #ffffff 55%);
      }

      #ranking-view .podium-card.place-2 {
        border-color: #cbd5e1;
        background: linear-gradient(180deg, #f8fafc, #ffffff 60%);
      }

      #ranking-view .podium-card.place-3 {
        border-color: #fdba74;
        background: linear-gradient(180deg, #fff7ed, #ffffff 60%);
      }

      #ranking-view .podium-head {
        display: flex;
        justify-content: space-between;
        align-items: baseline;
        gap: 10px;
      }

      #ranking-view .podium-badge {
        font-weight: 900;
        font-size: 18px;
        letter-spacing: 0.02em;
      }

      #ranking-view .podium-pt {
        font-size: 14px;
        font-weight: 800;
        color: #475569;
        border: 1px solid var(--border);
        background: #fff;
        padding: 6px 10px;
        border-radius: 999px;
      }

      #ranking-view .podium-media {
        border-radius: 18px;
        border: 1px solid var(--border);
        background: #f8fafc;
        overflow: hidden;
      }

      #ranking-view .podium-media img {
        width: 100%;
        height: 320px;
        object-fit: contain;
        display: block;
      }

      #ranking-view .podium-card.place-1 .podium-media img {
        height: 400px;
      }

      #ranking-view .podium-card.place-2 .podium-media img {
        height: 340px;
      }

      #ranking-view .podium-card.place-3 .podium-media img {
        height: 320px;
      }

      #ranking-view .podium-title {
        font-size: 22px;
        font-weight: 900;
        line-height: 1.2;
      }

      #ranking-view .podium-card.place-1 .podium-title {
        font-size: 24px;
      }

      #ranking-view .podium-card.place-2 .podium-title {
        font-size: 21px;
      }

      #ranking-view .podium-card.place-3 .podium-title {
        font-size: 20px;
      }

      #ranking-view .podium-meta {
        font-size: 14px;
        color: #64748b;
      }

      #ranking-view .podium-total {
        font-size: 14px;
        font-weight: 800;
        color: #0f172a;
        background: #f8fafc;
        border: 1px dashed #e2e8f0;
        border-radius: 14px;
        padding: 8px 10px;
      }

      @media (max-width: 720px) {
        #ranking-view .podium {
          grid-template-columns: 1fr;
          gap: 12px;
          align-items: stretch;
        }

        #ranking-view .podium-card.place-1 {
          transform: none;
        }

        #ranking-view .podium-media img {
          height: 240px;
        }

        #ranking-view .podium-card.place-1 .podium-media img {
          height: 260px;
        }

        #ranking-view .podium-card.place-2 .podium-media img {
          height: 240px;
        }

        #ranking-view .podium-card.place-3 .podium-media img {
          height: 230px;
        }

        #ranking-view .podium-title {
          font-size: 20px;
        }

        #ranking-view .podium-card.place-1 .podium-title {
          font-size: 22px;
        }

        #ranking-view .podium-card.place-2 .podium-title {
          font-size: 20px;
        }

        #ranking-view .podium-card.place-3 .podium-title {
          font-size: 19px;
        }
      }

      @media (max-width: 380px) {
        #ranking-view .podium-media img {
          height: 210px;
        }

        #ranking-view .podium-card.place-1 .podium-media img {
          height: 230px;
        }

        #ranking-view .podium-title {
          font-size: 18px;
        }
      }

      .ranking-cards {
        display: grid;
        gap: 10px;
        margin-top: 10px;
      }

      .ranking-card {
        display: grid;
        grid-template-columns: 44px 1fr auto;
        gap: 12px;
        align-items: center;
        background: #fff;
        border: 1px solid var(--border);
        border-radius: 14px;
        padding: 12px;
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.05);
      }

      .top {
        border-color: #d1d5db;
        box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
      }

      .top-1 {
        border-color: #fbbf24;
        background: #fff7ed;
      }

      .top-2 {
        border-color: #cbd5e1;
        background: #f8fafc;
      }

      .top-3 {
        border-color: #fdba74;
        background: #fff7ed;
      }

      .ranking-rank {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: #f3f4f6;
        border: 1px solid var(--border);
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 800;
        color: #111827;
      }

      .ranking-rank.top-rank {
        background: #111827;
        color: #fff;
        border-color: transparent;
      }

      .ranking-main {
        display: flex;
        align-items: center;
        gap: 10px;
        min-width: 0;
      }

      .ranking-thumb {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--muted);
        overflow: hidden;
        flex: 0 0 auto;
      }

      .ranking-thumb img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      .ranking-info {
        min-width: 0;
        display: flex;
        flex-direction: column;
        gap: 2px;
      }

      .ranking-name {
        font-weight: 700;
        color: #111827;
        line-height: 1.25;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .ranking-sub {
        font-size: 12px;
        color: var(--subtext);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .ranking-meta {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
        white-space: nowrap;
      }

      .ranking-points {
        font-weight: 800;
        color: #1f2937;
      }

      .ranking-price {
        font-size: 12px;
        color: var(--subtext);
      }

      .ranking-table-wrapper {
        overflow-x: auto;
        border-radius: 14px;
        border: 1px solid var(--border);
        box-shadow: var(--shadow);
        background: #fff;
      }

      .ranking-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 560px;
      }

      .ranking-table th,
      .ranking-table td {
        padding: 12px;
        border-bottom: 1px solid var(--border);
        text-align: left;
        font-size: 14px;
      }

      .ranking-table th {
        background: var(--muted);
        font-weight: 700;
      }

      .ranking-table tbody tr:hover {
        background: #fafaf9;
      }
      
      .ranking-table tr.rank-top td {
        font-size: 17px;
        padding: 16px;
      }

      .ranking-table tr.rank-top td:first-child {
        font-weight: 700;
        color: #1d4ed8;
      }

      .ranking-table tr.rank-top .ranking-product-thumb {
        width: 64px;
        height: 64px;
      }

      .ranking-table tr.rank-top .ranking-product-name {
        font-size: 17px;
        font-weight: 700;
      }

      .ranking-product {
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .ranking-product-thumb {
        width: 44px;
        height: 44px;
        border-radius: 10px;
        border: 1px solid var(--border);
        background: var(--muted);
        overflow: hidden;
        flex: 0 0 auto;
      }

      .ranking-product-thumb img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        display: block;
      }

      .ranking-product-name {
        font-weight: 600;
        color: var(--text);
        line-height: 1.35;
      }

      @media (max-width: 720px) {
        .selection-layout {
          grid-template-columns: 1fr;
          gap: 12px;
        }
        .selection-panel {
          order: -1;
          position: static;
          max-height: none;
        }
        .selection-panel__body {
          overflow: visible;
        }
        .selection-panel__footer {
          position: static;
          border-top: none;
          padding-top: 0;
        }
        .rank-item {
          padding: 12px;
          gap: 10px;
        }
        .rank-thumb {
          width: 92px;
          height: 92px;
          border-radius: 14px;
        }
        .rank-label {
          min-width: 76px;
          font-size: 16px;
        }
        .rank-content {
          font-size: 16px;
        }
        .rank-content > div:first-child {
          font-size: 18px;
        }
        .rank-content .muted {
          font-size: 12px;
        }
        #ranking-view .result-top3-media img {
          height: 240px;
        }
        .vending-area {
          order: 0;
        }
        .card-grid {
          grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .card {
          padding: 10px;
          border-radius: 14px;
        }
        .media-frame {
          min-height: 140px;
        }
        .card h4 {
          font-size: 14px;
        }
        .card .meta {
          font-size: 12px;
        }
        .category-tabs {
          gap: 8px;
        }
        .tab {
          padding: 10px 14px;
          font-size: 14px;
        }
        button.primary {
          width: 100%;
          justify-content: center;
        }
      }

      @media (max-width: 380px) {
        .rank-thumb {
          width: 80px;
          height: 80px;
        }
        .rank-label {
          min-width: 68px;
          font-size: 15px;
        }
        .rank-content > div:first-child {
          font-size: 17px;
        }
        .card-grid {
          grid-template-columns: 1fr;
        }
      }

      @media (max-width: 600px) {
        .selection-layout {
          grid-template-columns: 1fr;
        }
        h1 {
          font-size: 24px;
        }
        .ranking-table {
          min-width: 100%;
        }
        .ranking-card {
          grid-template-columns: 40px 1fr;
          grid-template-areas:
            'rank main'
            'meta meta';
        }
        .ranking-rank {
          grid-area: rank;
        }
        .ranking-main {
          grid-area: main;
        }
        .ranking-meta {
          grid-area: meta;
          flex-direction: row;
          justify-content: flex-end;
          gap: 10px;
        }
        .ranking-name {
          white-space: normal;
          display: -webkit-box;
          -webkit-line-clamp: 2;
          -webkit-box-orient: vertical;
          overflow: hidden;
        }
      }

      /* æŠ•ç¥¨ç”»é¢ã®TOP3ã¯æ¨™æº–ã‚µã‚¤ã‚ºã«å›ºå®šï¼ˆç‰¹å¤§åŒ–ã®å½±éŸ¿ã‚’é®æ–­ï¼‰ */
      #form-view .rank-thumb {
        width: 60px;
        height: 60px;
        border-radius: 10px;
      }

      #form-view .rank-label {
        font-size: 14px;
        min-width: 70px;
      }

      #form-view .rank-content {
        font-size: 14px;
      }

      #form-view .rank-item {
        padding: 10px;
        border-radius: 10px;
      }
    </style>
  </head>
  <body style="margin:auto 0;padding:auto 0;">
    <div class="page">
      <div id="form-view" class="view active">
        <header class="hero">
          <div class="hero-badges">
            <span class="pill accent">New Office Break Time</span>
            <span class="pill alt">ã¿ã‚“ãªã§æŠ•ç¥¨</span>
          </div>
          <h1>è‡ªè²©æ©Ÿã‚¢ãƒ³ã‚±ãƒ¼ãƒˆ</h1>
          <p class="lead">
            ç½®ã„ã¦æ¬²ã—ã„é£²ã¿ç‰©ã‚’æ•™ãˆã¦ãã ã•ã„ï¼äººæ°—é †ã§ã‚¢ã‚µãƒ’ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ã‚Šã¾ã™ã€‚
          <br />æš–ã‹ããªã‚‹å‰4æœˆãã‚‰ã„ã¾ã§ã§è²·ã„ãã†ãªã‚‚ã®ã‚’ãŠé¡˜ã„ã„ãŸã—ã¾ã™ï¼
          </p>
        </header>

        <section id="q1">
          <div class="section-header">
            <div>
              <p class="eyebrow">STEP 1</p>
              <h2>â‘ è‡ªè²©æ©Ÿã§è²·ã„ãã†ãªç‰©ã‚’3ã¤ã¾ã§é¸æŠã—ã¦ãã ã•ã„</h2>
              <p class="section-lead">
                ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸ã¹ã¾ã™ã€‚ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã‚‚OKã€‚
                <br />1ä½3pt/2ä½2pt/3ä½1ptã§é›†è¨ˆã•ã‚Œã¾ã™ã€‚
              </p>
            </div>
          </div>
          <div class="selection-layout">
            <div class="vending-area">
              <div class="category-tabs" id="category-tabs"></div>
              <div class="vending-window">
                <div id="product-grid" class="card-grid"></div>
              </div>
            </div>
            <aside class="selection-panel" id="selection-panel">
              <div class="selection-panel__head">
                <h3>ã‚ãªãŸã®TOP3</h3>
                <div class="counter" id="product-count">0/3</div>
              </div>
              <div class="selection-panel__body">
                <div class="rank-list" id="rank-list"></div>
                <div class="status" id="status"></div>
              </div>
            </aside>
          </div>
        </section>

        <section id="q2">
          <div class="section-header">
            <div>
              <p class="eyebrow">STEP 2</p>
              <h2>â‘¡ğŸ™ è»½é£Ÿè²©å£²ã‚³ãƒ¼ãƒŠãƒ¼ã«ã¤ã„ã¦</h2>
              <p class="section-lead">
                è‡ªè²©æ©Ÿã®æ¨ªã«è»½é£Ÿè²©å£²ã‚³ãƒ¼ãƒŠãƒ¼ã‚’è¨­ç½®ã—ã¾ã™ï¼åƒã„ã¦ã„ã‚‹æ™‚ã«é£Ÿã¹ãŸããªã‚‹ã‚‚ã®ã‚„ã€ã‚³ãƒ³ãƒ“ãƒ‹ç­‰ã§ã‚ˆãè²·ã†ã‚‚ã®ã‚’æ•™ãˆã¦ãã ã•ã„ï¼
              </p>
            </div>
          </div>

          <div class="q2-controls">
            <button type="button" class="chip" id="snack-none-btn" aria-pressed="false">ç‰¹ã«ãªã—</button>
            <p class="q2-hint">ã€Œç‰¹ã«ãªã—ã€ã¾ãŸã¯è‡ªç”±è¨˜å…¥ã®ã©ã¡ã‚‰ã‹ãŒå¿…é ˆã§ã™ã€‚</p>
          </div>

          <textarea
            id="snack-text"
            placeholder="ä¾‹ï¼šãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆã€ã‚«ãƒƒãƒ—å‘³å™Œæ±ã€ãƒŠãƒƒãƒ„ã€è“å­ãƒ‘ãƒ³ ãªã©"
          ></textarea>
        </section>

        <section id="submit-section">
          <button class="primary" id="submit-btn">ã“ã®å†…å®¹ã§é€ä¿¡ã™ã‚‹</button>
        </section>
      </div>

      <section id="ranking-view" class="view ranking-view">
        <div class="ranking-header">
          <div>
            <p class="eyebrow">çµæœãƒšãƒ¼ã‚¸</p>
            <h2>ã¿ã‚“ãªã®ç¾åœ¨ã®é †ä½</h2>
            <p class="section-lead">æœ€æ–°ã®Pté †ã§ä¸Šä½15ä»¶ã‚’è¡¨ç¤ºã—ã¦ã„ã¾ã™ã€‚</p>
            <p class="ranking-note">
              é›†è¨ˆã¯å®Œäº†ã—ã¦ã„ã¾ã™ã€‚ã“ã®ç”»é¢ã¯é–‰ã˜ã¦ã„ãŸã ã„ã¦å•é¡Œã‚ã‚Šã¾ã›ã‚“ã€‚
            </p>
          </div>
        </div>
        <div class="ranking-layout">
          <div class="ranking-results">
            <div id="ranking-top3" class="ranking-top3"></div>
            <div class="status" id="ranking-status">æœ€æ–°ã®é †ä½ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...</div>
            <div id="ranking-cards" class="ranking-cards"></div>
          </div>
        </div>
      </section>
    </div>

      <script>
      const state = {
        categories: [],
        selectedCategory: null,
        selection: { selectedProducts: [null, null, null], activeRank: 0 },
        freeText: '',
        snackNone: false,
        snackText: '',
      };
      const DEBUG = false;
      const productImageMap = new Map();
      const dragState = {
        source: null,
        product: null,
        fromIndex: null,
      };
      const FALLBACK_IMAGE =
        'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="360" height="240" viewBox="0 0 360 240"><rect width="360" height="240" fill="%23f2f4f7"/><rect x="30" y="30" width="300" height="180" rx="12" fill="none" stroke="%23c3cad4" stroke-width="8"/><path d="M96 166l48-58 48 58 48-72 24 32" fill="none" stroke="%23c3cad4" stroke-width="10" stroke-linecap="round" stroke-linejoin="round"/><circle cx="138" cy="90" r="22" fill="%23d8dde5"/></svg>';
      const IMAGE_SIZES = {
        card: 300,
        thumb: 64,
        ranking: 44,
        resultTop3: 480,
      };
      const IMAGE_DIMENSIONS = {
        card: { width: 240, height: 320 },
        thumb: { width: 60, height: 60 },
        ranking: { width: 44, height: 44 },
        resultTop3: { width: 480, height: 360 },
      };
      const RANK_POINTS = [3, 2, 1];
      const isTouch = matchMedia('(pointer:coarse)').matches;

      const els = {
        tabs: document.getElementById('category-tabs'),
        productGrid: document.getElementById('product-grid'),
        count: document.getElementById('product-count'),
        status: document.getElementById('status'),
        submit: document.getElementById('submit-btn'),
        rankList: document.getElementById('rank-list'),
        formView: document.getElementById('form-view'),
        rankingView: document.getElementById('ranking-view'),
        rankingStatus: document.getElementById('ranking-status'),
        rankingTop3: document.getElementById('ranking-top3'),
        rankingList: document.getElementById('ranking-cards'),
        snackNoneBtn: document.getElementById('snack-none-btn'),
        snackText: document.getElementById('snack-text'),
      };

      const viewState = { current: 'form' };

      function buildProductImageMap() {
        productImageMap.clear();
        (state.categories || []).forEach((category) => {
          (category.items || []).forEach((item) => {
            const key = String(item.product || '').trim();
            if (key && item.imageUrl) {
              productImageMap.set(key, item.imageUrl);
            }
          });
        });
      }

      function normalizeUrl(u) {
        return String(u || '')
          .replace(/&amp;/g, '&')
          .trim();
      }

      function getSelection() {
        return state.selection;
      }

      function setStatus(message, isError = false) {
        const has = Boolean(message && String(message).trim());
        els.status.textContent = has ? message : '';
        els.status.classList.toggle('error', Boolean(isError));
        els.status.style.display = has ? 'block' : 'none';
      }

      function setRankingStatus(message, isError = false) {
        if (!els.rankingStatus) return;
        const text = (message || '').trim();
        els.rankingStatus.textContent = text;
        els.rankingStatus.classList.toggle('error', Boolean(isError));
        els.rankingStatus.classList.toggle('visible', Boolean(text));
      }

      function switchView(target) {
        viewState.current = target;
        els.formView.classList.toggle('active', target === 'form');
        els.rankingView.classList.toggle('active', target === 'ranking');
        window.scrollTo({ top: 0, behavior: 'smooth' });
      }

      function getOptimizedImageUrl(src, size) {
        const raw = normalizeUrl(src);
        if (!raw) return '';
        if (raw.startsWith('data:')) return raw;
        if (!size) return raw;
        if (!raw.includes('googleusercontent.com')) return raw;
        if (/=w\d+/i.test(raw)) return raw.replace(/=w\d+/gi, `=w${size}`);
        if (/=s\d+/i.test(raw)) return raw.replace(/=s\d+/gi, `=w${size}`);
        return `${raw}=w${size}`;
      }

      function preloadImages(urls) {
        urls
          .filter(Boolean)
          .slice(0, 6)
          .forEach((url) => {
            const img = new Image();
            img.decoding = 'async';
            img.src = url;
          });
      }

      function configureImage(img, options = {}) {
        const { src, alt, size, width, height, fetchPriority, loading } = options;
        img.loading = loading || 'lazy';
        img.decoding = 'async';
        img.alt = alt || 'image preview';
        img.referrerPolicy = 'no-referrer';
        if (fetchPriority) img.fetchPriority = fetchPriority;
        if (width) img.width = width;
        if (height) img.height = height;

        const applyFallback = () => {
          img.onerror = null;
          img.src = FALLBACK_IMAGE;
        };

        img.onerror = applyFallback;
        img.src = getOptimizedImageUrl(src, size) || FALLBACK_IMAGE;
      }

      function createImageElement(src, alt, options = {}) {
        const wrapper = document.createElement('div');
        wrapper.className = 'media-frame';

        const img = document.createElement('img');
        configureImage(img, { src, alt, ...options });

        wrapper.appendChild(img);
        return wrapper;
      }

      function resetDragState() {
        dragState.source = null;
        dragState.product = null;
        dragState.fromIndex = null;
        if (els.rankList) {
          els.rankList.querySelectorAll('.rank-item').forEach((row) => row.classList.remove('drag-over'));
        }
      }

      function startCatalogDrag(event, item) {
        dragState.source = 'catalog';
        dragState.product = item;
        dragState.fromIndex = null;
        if (event?.dataTransfer) {
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', `${item.category}:${item.product}`);
        }
      }

      function startRankDrag(event, index) {
        const selection = getSelection();
        const product = selection.selectedProducts[index];
        if (!product) return;
        dragState.source = 'rank';
        dragState.product = product;
        dragState.fromIndex = index;
        if (event?.dataTransfer) {
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', `${product.category}:${product.product}`);
        }
      }

      function handleRankDragOver(event) {
        event.preventDefault();
        event.dataTransfer && (event.dataTransfer.dropEffect = 'move');
        event.currentTarget.classList.add('drag-over');
      }

      function handleRankDragLeave(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('drag-over');
      }

      function handleRankDrop(event, index) {
        event.preventDefault();
        event.currentTarget.classList.remove('drag-over');
        if (!dragState.product) return;

        if (dragState.source === 'rank') {
          reorderSelectedProducts(dragState.fromIndex, index);
        } else {
          placeProductAtRank(dragState.product, index);
        }
        resetDragState();
      }

      function updateCount() {
        const filled = getSelection().selectedProducts.filter(Boolean).length;
        els.count.textContent = `${filled}/3`;
      }

      function updateSubmitAvailability() {
        const selection = getSelection();
        const filledTop3 = selection.selectedProducts.filter(Boolean).length === 3;
        const snackText = (state.snackText || '').trim();
        const snackOk = Boolean(state.snackNone) || snackText.length > 0;
        els.submit.disabled = !(filledTop3 && snackOk);
      }

      function updateProductSelections() {
        const cards = els.productGrid.querySelectorAll('.product-card');
        const selection = getSelection();
        cards.forEach((card) => {
          const { category, product } = card.dataset;
          const rankIndex = selection.selectedProducts.findIndex(
            (p) => p && p.category === category && p.product === product
          );
          const hasRank = rankIndex >= 0;
          card.classList.toggle('selected', hasRank);

          let rankBadge = card.querySelector('.rank-badge');
          if (hasRank) {
            if (!rankBadge) {
              rankBadge = document.createElement('span');
              rankBadge.className = 'rank-badge';
              card.insertBefore(rankBadge, card.firstChild);
            }
            rankBadge.textContent = `${rankIndex + 1}ä½ / ${RANK_POINTS[rankIndex]}pt`;
          } else if (rankBadge) {
            rankBadge.remove();
          }
        });
        updateCount();
        updateSubmitAvailability();
      }

      function renderTabs() {
        els.tabs.innerHTML = '';
        state.categories.forEach((cat, idx) => {
          const button = document.createElement('button');
          button.className = 'tab' + (state.selectedCategory === cat.name || (!state.selectedCategory && idx === 0) ? ' active' : '');
          button.textContent = cat.name;
          button.addEventListener('click', () => {
            state.selectedCategory = cat.name;
            renderTabs();
            renderProducts();
          });
          els.tabs.appendChild(button);
        });
        if (!state.selectedCategory && state.categories.length) {
          state.selectedCategory = state.categories[0].name;
        }
      }

      function renderProducts() {
        els.productGrid.innerHTML = '';
        const category = state.categories.find((c) => c.name === state.selectedCategory);
        if (!category || !category.items.length) {
          delete els.productGrid.dataset.category;
          const empty = document.createElement('div');
          empty.className = 'empty';
          empty.textContent = 'ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«ã¯å•†å“ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
          els.productGrid.appendChild(empty);
          updateCount();
          return;
        }

        els.productGrid.dataset.category = category.name;
        const seen = new Set();
        const uniqueItems = category.items.filter((item) => {
          const key = `${item.category}__${item.product}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        const preloadUrls = uniqueItems
          .slice(0, 6)
          .map((item) => getOptimizedImageUrl(item.imageUrl, IMAGE_SIZES.card));
        preloadImages(preloadUrls);

        const frag = document.createDocumentFragment();
        uniqueItems.forEach((item, idx) => {
          const card = document.createElement('div');
          card.className = 'card product-card';
          card.dataset.category = item.category;
          card.dataset.product = item.product;

          const priority = idx < 6 ? 'high' : 'low';
          const loading = idx < 6 ? 'eager' : 'lazy';
          let img = card.querySelector('.media-frame');
          if (!img) {
            img = createImageElement(item.imageUrl, item.product, {
              size: IMAGE_SIZES.card,
              width: IMAGE_DIMENSIONS.card.width,
              height: IMAGE_DIMENSIONS.card.height,
              fetchPriority: priority,
              loading,
            });
          }
          const badge = document.createElement('span');
          badge.className = 'badge';
          badge.textContent = item.category;

          const meta = document.createElement('div');
          meta.className = 'meta';
          const price = document.createElement('span');
          price.className = 'price';
          price.textContent = item.price || '';
          meta.appendChild(price);

          const title = document.createElement('h4');
          title.textContent = item.product;

          card.appendChild(img);
          card.appendChild(badge);
          card.appendChild(meta);
          card.appendChild(title);

          card.draggable = true;
          card.addEventListener('dragstart', (event) => startCatalogDrag(event, item));
          card.addEventListener('dragend', resetDragState);
          card.addEventListener('click', () => assignProductToActiveRank(item));
          frag.appendChild(card);
        });
        els.productGrid.appendChild(frag);

        updateProductSelections();
      }

      function placeProductAtRank(item, targetIndex) {
        if (!item) return;
        const index = typeof targetIndex === 'number' ? targetIndex : 0;
        const selection = getSelection();
        const products = [...selection.selectedProducts];
        const duplicateIndex = products.findIndex((p) => p && p.category === item.category && p.product === item.product);

        if (duplicateIndex >= 0 && duplicateIndex !== index) {
          products[duplicateIndex] = null;
        }

        products[index] = { ...item, selectedAt: Date.now() };
        selection.selectedProducts = products.slice(0, 3);
        selection.activeRank = index;
        updateProductSelections();
        renderRankList();
        updateSubmitAvailability();
      }

      function reorderSelectedProducts(fromIndex, toIndex) {
        if (fromIndex === toIndex || fromIndex == null || toIndex == null) return;
        const selection = getSelection();
        const products = [...selection.selectedProducts];
        const [moving] = products.splice(fromIndex, 1);
        if (!moving) return;
        products.splice(toIndex, 0, moving);
        while (products.length < 3) products.push(null);
        selection.selectedProducts = products.slice(0, 3);
        selection.activeRank = toIndex;
        updateProductSelections();
        renderRankList();
        updateSubmitAvailability();
      }

      function assignProductToActiveRank(item) {
        const selection = getSelection();
        const emptyIndex = selection.selectedProducts.findIndex((p) => !p);
        const activeIndex = typeof selection.activeRank === 'number' ? selection.activeRank : 0;
        const targetIndex = emptyIndex >= 0 && selection.selectedProducts[activeIndex] ? emptyIndex : activeIndex;
        placeProductAtRank(item, targetIndex);
        updateSubmitAvailability();
      }

      function renderRankList() {
        if (!els.rankList) return;
        els.rankList.innerHTML = '';

        const selection = getSelection();
        selection.selectedProducts.forEach((item, idx) => {
          const row = document.createElement('div');
          row.className = `rank-item${selection.activeRank === idx ? ' active' : ''}`;
          row.dataset.index = idx;
          row.addEventListener('dragover', handleRankDragOver);
          row.addEventListener('dragenter', handleRankDragOver);
          row.addEventListener('dragleave', handleRankDragLeave);
          row.addEventListener('drop', (event) => handleRankDrop(event, idx));
          row.addEventListener('click', () => {
            selection.activeRank = idx;
            renderRankList();
          });

          const label = document.createElement('div');
          label.className = 'rank-label';
          label.textContent = `${idx + 1}ä½ / ${RANK_POINTS[idx]}pt`;

          const thumb = document.createElement('div');
          thumb.className = 'rank-thumb';
          if (item) {
            const img = document.createElement('img');
            configureImage(img, {
              src: item?.imageUrl,
              alt: item?.product || 'é¸æŠ',
              size: IMAGE_SIZES.card,
              width: IMAGE_DIMENSIONS.card.width,
              height: IMAGE_DIMENSIONS.card.height,
              fetchPriority: 'low',
            });
            thumb.appendChild(img);
          }

          const content = document.createElement('div');
          content.className = 'rank-content';

          if (item) {
            const title = document.createElement('div');
            title.textContent = item.product;
            const meta = document.createElement('div');
            meta.className = 'muted';
            meta.textContent = `${item.category || ''}${item.price ? ' / ' + item.price : ''}`;
            content.appendChild(title);
            content.appendChild(meta);

            row.draggable = true;
            row.addEventListener('dragstart', (event) => startRankDrag(event, idx));
            row.addEventListener('dragend', resetDragState);
          } else {
            const title = document.createElement('div');
            title.className = 'rank-empty';
            title.textContent = 'æœªé¸æŠ';
            const meta = document.createElement('div');
            meta.className = 'muted';
            meta.textContent = 'ã‚¿ãƒƒãƒ—ã—ã¦é †ä½ã«ã‚»ãƒƒãƒˆ';
            content.appendChild(title);
            content.appendChild(meta);
            row.removeAttribute('draggable');
          }

          row.appendChild(label);
          row.appendChild(thumb);
          row.appendChild(content);
          els.rankList.appendChild(row);
        });
        updateCount();
        updateSubmitAvailability();
      }

      function handleSubmit() {
        setStatus('');
        els.submit.disabled = true;
        const selection = getSelection();
        const filledProducts = selection.selectedProducts.filter(Boolean);
        if (filledProducts.length !== 3) {
          setStatus('3ã¤é¸ã‚“ã§ã„ãŸã ã‘ã‚‹ã¨é€ä¿¡ã§ãã¾ã™ã€‚', true);
          els.submit.disabled = false;
          return;
        }

        const snackText = (state.snackText || '').trim();
        const snackOk = state.snackNone || snackText.length > 0;
        if (!snackOk) {
          setStatus('ã€Œç‰¹ã«ãªã—ã€ã¾ãŸã¯è‡ªç”±è¨˜å…¥ã®ã©ã¡ã‚‰ã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', true);
          els.submit.disabled = false;
          return;
        }

        const payload = {
          selectedProducts: getCleanProducts(selection),
          freeText: (state.freeText || '').trim(),
          snackNone: Boolean(state.snackNone),
          snackText: snackText,
        };

        google.script.run
          .withSuccessHandler(() => {
            setStatus('ã”å›ç­”ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸã€‚ã¿ãªã•ã‚“ã®ã”æ„è¦‹ã‚’é›†è¨ˆã—ã¾ã™ã€‚');
            state.selection = { selectedProducts: [null, null, null], activeRank: 0 };
            state.freeText = '';
            state.snackNone = false;
            state.snackText = '';
            if (els.snackNoneBtn) {
              els.snackNoneBtn.setAttribute('aria-pressed', 'false');
            }
            if (els.snackText) {
              els.snackText.value = '';
            }
            renderProducts();
            renderRankList();
            updateSubmitAvailability();
            fetchRankingSummary();
          })
          .withFailureHandler((err) => {
            setStatus(err?.message || 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
            els.submit.disabled = false;
          })
          .submitResponse(payload);
      }

      function fetchRankingSummary() {
        if (!els.rankingStatus || !els.rankingList) return;
        setRankingStatus('æœ€æ–°ã®é †ä½ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...');
        els.rankingList.innerHTML = '';
        switchView('ranking');

        google.script.run
          .withSuccessHandler((data) => {
            if (DEBUG) console.log('getRankingSummary raw:', data);
            const rankings = normalizeRankingResponse(data);
            if (DEBUG) console.log('normalized products:', rankings.products);
            const hasData = renderRankingTable(rankings.products);
            setRankingStatus(hasData ? '' : 'ã¾ã é›†è¨ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æœ€åˆã®æŠ•ç¥¨ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚');
          })
          .withFailureHandler((err) => {
            setRankingStatus(err?.message || 'é †ä½ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚å°‘ã—æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚', true);
          })
          .getRankingSummary();
      }

      function normalizeRankingResponse(data) {
        const products = Array.isArray(data?.products) ? data.products : Array.isArray(data) ? data : [];

        return {
          products,
        };
      }

      function renderRankingTop3(top3Items) {
        const box = document.getElementById('ranking-top3');
        if (!box) return;
        box.innerHTML = '';

        const podium = document.createElement('div');
        podium.className = 'podium';

        const isMobile = window.matchMedia('(max-width: 720px)').matches;
        const order = isMobile
          ? [
              { idx: 0, place: 1, medal: 'ğŸ‘‘', cls: 'podium-card place-1' },
              { idx: 1, place: 2, medal: 'ğŸ¥ˆ', cls: 'podium-card place-2' },
              { idx: 2, place: 3, medal: 'ğŸ¥‰', cls: 'podium-card place-3' },
            ]
          : [
              { idx: 1, place: 2, medal: 'ğŸ¥ˆ', cls: 'podium-card place-2' },
              { idx: 0, place: 1, medal: 'ğŸ‘‘', cls: 'podium-card place-1' },
              { idx: 2, place: 3, medal: 'ğŸ¥‰', cls: 'podium-card place-3' },
            ];

        order.forEach(({ idx, place, medal, cls }) => {
          const item = top3Items[idx];

          const card = document.createElement('div');
          card.className = cls;

          const head = document.createElement('div');
          head.className = 'podium-head';

          const badge = document.createElement('div');
          badge.className = 'podium-badge';
          badge.textContent = `${medal} ${place}ä½`;

          const pt = document.createElement('div');
          pt.className = 'podium-pt';
          const pointText = place === 1 ? '4pt' : place === 2 ? '2pt' : '1pt';
          pt.textContent = pointText;

          head.appendChild(badge);
          head.appendChild(pt);

          const media = document.createElement('div');
          media.className = 'podium-media';
          const img = document.createElement('img');
          const resolvedSrc =
            item?.imageUrl || productImageMap.get(String(item?.product || '').trim()) || FALLBACK_IMAGE;
          configureImage(img, {
            src: resolvedSrc,
            alt: item?.product || 'å•†å“ç”»åƒ',
            size: place === 1 ? 640 : 520,
            width: place === 1 ? 480 : 420,
            height: place === 1 ? 480 : 420,
            fetchPriority: 'high',
            loading: 'eager',
          });
          media.appendChild(img);

          const title = document.createElement('div');
          title.className = 'podium-title';
          title.textContent = item?.product || 'ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰';

          const meta = document.createElement('div');
          meta.className = 'podium-meta';
          meta.textContent = item
            ? `${item.category || ''}${item.price ? ' / ' + item.price : ''}`
            : '';

          const points = document.createElement('div');
          points.className = 'podium-total';
          points.textContent = `åˆè¨ˆ ${item?.points || 0} Pt`;

          card.appendChild(head);
          card.appendChild(media);
          card.appendChild(title);
          card.appendChild(meta);
          card.appendChild(points);

          podium.appendChild(card);
        });

        box.appendChild(podium);
      }

      function renderRankingTable(products) {
        els.rankingList.innerHTML = '';
        const items = Array.isArray(products) ? products.slice(0, 15) : [];
        if (!items.length) {
          renderRankingTop3([]);
          return false;
        }

        renderRankingTop3(items.slice(0, 3));

        const frag = document.createDocumentFragment();
        items.slice(3).forEach((item, listIndex) => {
          const rankPosition = listIndex + 4;
          const card = document.createElement('div');
          card.className = 'ranking-card';

          const rank = document.createElement('div');
          rank.className = 'ranking-rank';
          rank.textContent = String(rankPosition);

          const main = document.createElement('div');
          main.className = 'ranking-main';

          const thumb = document.createElement('div');
          thumb.className = 'ranking-thumb';
          const img = document.createElement('img');
          const resolvedSrc =
            item?.imageUrl || productImageMap.get(String(item?.product || '').trim()) || FALLBACK_IMAGE;
          if (DEBUG) {
            console.log('ranking image resolve', {
              product: item?.product,
              imageUrl: item?.imageUrl,
              resolvedSrc,
            });
          }
          configureImage(img, {
            src: resolvedSrc,
            alt: item?.product || 'å•†å“',
            size: IMAGE_SIZES.ranking,
            width: IMAGE_DIMENSIONS.ranking.width,
            height: IMAGE_DIMENSIONS.ranking.height,
            fetchPriority: 'low',
            loading: 'lazy',
          });
          thumb.appendChild(img);

          const info = document.createElement('div');
          info.className = 'ranking-info';

          const name = document.createElement('div');
          name.className = 'ranking-name';
          name.textContent = item?.product || 'å•†å“åä¸æ˜';

          const sub = document.createElement('div');
          sub.className = 'ranking-sub';
          sub.textContent = [item?.category].filter(Boolean).join(' / ');

          info.appendChild(name);
          if (sub.textContent) info.appendChild(sub);

          main.appendChild(thumb);
          main.appendChild(info);

          const meta = document.createElement('div');
          meta.className = 'ranking-meta';

          const points = document.createElement('div');
          points.className = 'ranking-points';
          points.textContent = `${item?.points || 0} Pt`;

          const price = document.createElement('div');
          price.className = 'ranking-price';
          price.textContent = item?.price || '';

          meta.appendChild(points);
          if (price.textContent) meta.appendChild(price);

          card.appendChild(rank);
          card.appendChild(main);
          card.appendChild(meta);
          frag.appendChild(card);
        });
        els.rankingList.appendChild(frag);

        return true;
      }

      function getCleanProducts(selection) {
        return selection.selectedProducts.map((p) => {
          if (!p) return null;
          const { selectedAt, ...rest } = p;
          return rest;
        });
      }

      function setupInputs() {
        if (els.snackNoneBtn) {
          els.snackNoneBtn.addEventListener('click', () => {
            state.snackNone = !state.snackNone;
            els.snackNoneBtn.setAttribute('aria-pressed', String(state.snackNone));
            updateSubmitAvailability();
          });
        }

        if (els.snackText) {
          els.snackText.addEventListener('input', (event) => {
            state.snackText = event.target.value || '';
            if ((state.snackText || '').trim().length > 0 && state.snackNone) {
              state.snackNone = false;
              if (els.snackNoneBtn) {
                els.snackNoneBtn.setAttribute('aria-pressed', 'false');
              }
            }
            updateSubmitAvailability();
          });
        }
      }

      function updateSectionLead() {
        const lead = document.querySelector('#q1 .section-lead');
        if (!lead) return;
        if (isTouch) {
          lead.innerHTML =
            'æ™®æ®µã‚ˆãé£²ã‚€é£²ã¿ç‰©ã‚’ã€1ä½ã€œ3ä½ã®é †ã§é¸ã‚“ã§ãã ã•ã„ã€‚<br>å•†å“ç”»åƒã‚’ã‚¿ãƒƒãƒ—ã™ã‚‹ã¨é¸æŠã§ãã¾ã™ã€‚é †ä½ã‚’å¤‰ãˆã‚‹ã¨ãã¯ã€ä¸Šã®æ ï¼ˆ1ä½/2ä½/3ä½ï¼‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã‹ã‚‰å•†å“ã‚’é¸ã³ç›´ã—ã¦ãã ã•ã„ã€‚';
          return;
        }
        lead.innerHTML =
          'æ™®æ®µã‚ˆãé£²ã‚€é£²ã¿ç‰©ã‚’ã€1ä½ã€œ3ä½ã®é †ã§é¸ã‚“ã§ãã ã•ã„ã€‚<br>å•†å“ç”»åƒã‚’ã‚¯ãƒªãƒƒã‚¯ã€ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã§ä¸¦ã³æ›¿ãˆã§ãã¾ã™ã€‚';
      }

      function load() {
        setStatus('èª­ã¿è¾¼ã¿ä¸­...');
        updateSectionLead();
        setupInputs();
        if (typeof google === 'undefined' || !google.script?.run) {
          setStatus('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã§ã¯ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚Apps Script ç’°å¢ƒã§ãŠè©¦ã—ãã ã•ã„ã€‚', true);
          els.submit.disabled = true;
          return;
        }

        google.script.run
          .withSuccessHandler((data) => {
            state.categories = data.categories || [];
            buildProductImageMap();
            renderTabs();
            renderProducts();
            renderRankList();
            setStatus('');
            updateSubmitAvailability();
          })
          .withFailureHandler((err) => {
            setStatus(err?.message || 'ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚©ãƒ«ãƒ€ã®æ¨©é™ã‚„IDã‚’ã”ç¢ºèªãã ã•ã„ã€‚', true);
          })
          .getInitialData();
      }

      els.submit.addEventListener('click', handleSubmit);
      document.addEventListener('DOMContentLoaded', load);
    </script>
  </body>
</html>
