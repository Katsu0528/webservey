# 自動販売機アンケート（Google Apps Script）

スプレッドシートとドライブのデータを元に、1ページで完結するアンケートフォームを提供します。飲みたい商品のTOP3を選択（1位=3pt / 2位=2pt / 3位=1pt）し、任意の自由記入欄を送信できます。

## 事前準備

1. 下記のように、カテゴリ別のシートを持つスプレッドシートを用意します。  
   - シート名：`コーヒー` / `エナドリ` / `水` / `お茶` / `炭酸` / `スポドリ` / `その他(果汁等)`  
   - A列: 商品名, B列: メーカー名, C列: 価格, D列: 画像URL（`https://lh3.googleusercontent.com/d/<ファイルID>` 形式で貼り付け）
   - 先頭行にヘッダー（例: 商品名 / メーカー名 / 価格 / 画像URL）があっても自動的にスキップされます。
2. 商品画像用のドライブフォルダを用意します。フォルダ直下に「カテゴリ名（シート名）」ごとのサブフォルダを作成し、その中に商品名（シートA列）と同名の画像ファイルを配置してください。  
   - フォルダ内の画像ファイル名を正とし、シート内の商品名と突き合わせてメーカー・価格を表示します。  
   - 画像URL列（D列）が空の場合でも、このフォルダ構成から自動で画像を引き当てます（ファイル名の拡張子は無視されます）。
3. Apps Script プロジェクトのスクリプトプロパティまたはコードの定数に、スプレッドシートIDとドライブフォルダIDを設定します。

## セットアップ手順

1. 新しい Apps Script プロジェクトを作成し、`Code.gs` と `index.html` の内容をそれぞれ貼り付けます。
2. `Code.gs` 冒頭の定数を環境に合わせて設定します。
   ```js
   const SPREADSHEET_ID = '1xkg8vNscpcWTA6GA0VPxGTJCAH6LyvsYhq7VhOlDcXg';
   const PRODUCT_FOLDER_ID = '18fA4HRavIBTM2aPL-OqVaWhjRRgBhlKg';
   ```
3. 必要に応じて `回答` シート（1位〜3位のまとめ）と `集計` シート（順位別に1行ずつ記録）が自動作成されるため、回答保存用のシートを事前に用意する必要はありません。
4. 「デプロイ」>「新しいデプロイ」でウェブアプリとして公開します。  
   - 実行するデプロイ：`doGet`  
   - アクセスできるユーザー：回答者に合わせて設定

## 画像URLの貼り付け形式

- Google ドライブに置いた画像は、`https://lh3.googleusercontent.com/d/<ファイルID>` の形式で `<img src="...">` に指定してください。
  - 共有リンク（例：`https://drive.google.com/file/d/XXXX/view`）やファイル ID (`XXXX`) から、`https://lh3.googleusercontent.com/d/XXXX` に置き換えれば利用できます。
- スプレッドシートの D 列（画像URL）が空の場合でも、フォルダ構成から自動で画像を引き当てますが、手動で指定する場合は上記形式で統一してください。

## 使い方

- フロントエンドは1ページ構成です。  
  1. カテゴリタブをクリックして商品を表示し、右側の「1位/2位/3位」枠をクリックしてアクティブにした状態で商品画像を押すと、その順位に選択されます（重複した場合は古い順位が解除）。右上に「0/3」のカウンター表示。  
  2. 任意で自由記入欄に要望を入力。  
- 「送信」ボタンで回答を送信すると、`回答` シートに「タイムスタンプ／1〜3位の商品／自由記入」が追記され、同時に `集計` シートに順位別のポイント（1位=3pt、2位=2pt、3位=1pt）が1行ずつ保存されます。

## 保存されるシート

- `回答` シートは、各順位の「カテゴリ／メーカー／商品名／価格」をそれぞれ別列で保持します（1位〜3位で計12列）。
- `集計` シートは、これまで通り1行1順位でポイントを保持しつつ、シート右側（列K以降）に「カテゴリ／メーカー／商品名／価格」単位の合計Ptと票数のサマリーテーブルを自動生成します。

## フォルダ・スプレッドシートの共有設定

- 画像表示のため、シートに記載するDrive画像URLやフォルダは「リンクを知っている全員が閲覧可能」など、フォーム利用者が閲覧できる権限を付与してください。

## 構成

- `Code.gs`：データ取得（シート・Drive）、回答保存、`doGet` エントリーポイントを提供するサーバーコード。
- `index.html`：UI/UX とフロントロジック。`google.script.run` で `getInitialData` と `submitResponse` を呼び出します。
